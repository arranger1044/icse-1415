   /*******************************************************/   /*      "C" Language Integrated Production System      */   /*                                                     */   /*             Macintosh Version 3.3  04/02/96         */   /*                                                     */   /*            EDIT MENU DIALOG MANAGER MODULE          */   /*******************************************************//*************************************************************//* Purpose:                                                  *//*                                                           *//* Principal Programmer(s):                                  *//*      Gary D. Riley                                        *//*                                                           *//* Contributing Programmer(s):                               *//*                                                           *//* Revision History:                                         *//*                                                           *//*************************************************************/#define _EDITDLOG_SOURCE_#include "setup.h"#include <string.h>#include <ctype.h>#include <Dialogs.h>#include <OSUtils.h>#if MAC_MPW || MAC_MCW#include <strings.h>#else#include <pascal.h>#endif#if MAC_SC7 || MAC_SC8#define CTOPSTR C2PStr#else#define CTOPSTR c2pstr#endif#if MAC_SC7 || MAC_MPW || MAC_MCW || MAC_SC8#define GRAY (&qd.gray)#define BLACK (&qd.black)#else#define GRAY (qd.gray)#define BLACK (qd.black)#endif#if MAC_SC7 || MAC_MCW || MAC_SC8#define ClickPtr ListClickLoopUPP#else#define ClickPtr ProcPtr#endif#if MAC_MCW || MAC_SC8#define ModalPtr ModalFilterUPP#else#define ModalPtr ModalFilterProcPtr#endif#include "symbol.h"#include "dlogmngr.h"#include "prefernc.h"#include "stnrdmac.h"#include "window.h"#include "editdlog.h"/***************************************//* LOCAL INTERNAL FUNCTION DEFINITIONS *//***************************************/   static void                   UpdateCommandCompletionButtons(DialogPtr,int);   static char                  *GetCompletionName(void *);   static void                  *GetNextCompletion(void *);/***************************************//* LOCAL INTERNAL VARIABLE DEFINITIONS *//***************************************/   static struct symbolMatch    *GlobalMatches = NULL;/****************************************//* GLOBAL INTERNAL VARIABLE DEFINITIONS *//****************************************/   int                     WarningsOption = TRUE;   int                     CommandCompletionDialog = TRUE;   int                     RememberEditWindowState = TRUE;   int                     RememberEnvironmentWindowState = TRUE;   int                     HonorEditWindowState = TRUE;   int                     HonorEnvironmentWindowState = TRUE;/**************************************************//* DoCommandCompletionDialog: Performs the dialog *//*   associated with the Complete... command.     *//**************************************************/char *DoCommandCompletionDialog(matches,command)  struct symbolMatch *matches;  char *command;  {   short int itemNumber = 0;   int selection;   int numberOfCompletions;   char nameBuffer[15];   /*==================================================*/   /* Use the name of the command in the dialog title. */   /*==================================================*/   if (strlen(command) > 8)     {      strncpy(nameBuffer,command,8);      strcpy(&nameBuffer[8],"...");     }   else     { strcpy(nameBuffer,command); }   CTOPSTR(nameBuffer);   /*====================*/   /* Create the dialog. */   /*====================*/   GlobalMatches = matches;   CreateDialogManager(COMM_COMP_DIALOG_RESOURCE_NUMBER,TRUE);   numberOfCompletions = PrepManager(COMM_COMP_DIALOG_SELECT,                                  GetNextCompletion,                                  GetCompletionName,TRUE,false,(StringPtr) nameBuffer);   /*===============================================================*/   /* Define a ClikLoop function to be called repeatedly as long as */   /* the mouse button is held down inside the list of items. This  */   /* loop will update buttons applicable to the currently selected */   /* item.                                                         */   /*===============================================================*/   UpdateConstructManagerButtonsFunction = UpdateCommandCompletionButtons;   (*Choices)->lClickLoop = (ClickPtr) DefaultConstructManagerClikloopRef;   /*==================================*/   /* Set up key selection parameters. */   /*==================================*/   strncpy(ListKeySelection,command,LIST_KEY_MAX);   ListKeyRestartPos = strlen(command);   if (ListKeyRestartPos > LIST_KEY_MAX) ListKeyRestartPos = LIST_KEY_MAX;   ListKeyCurrentPos = ListKeyRestartPos;   /*===========================================================*/   /* Set a global variable indicating which item in the dialog */   /* box is the list. This global value will be used by the    */   /* filter function for the dialog box.                       */   /*===========================================================*/   SelectItem = COMM_COMP_DIALOG_SELECT;   /*====================================================*/   /* Initialize the last dialog item selected variable. */   /*====================================================*/   itemNumber = COMM_COMP_DIALOG_SELECT;   /*====================================================================*/   /* Outline the Done button to indicate that it is the default button. */   /*====================================================================*/   OutlineButton(ManagerDialog,COMM_COMP_DIALOG_OK,TRUE);   /*==================================================================*/   /* Remain in this loop until the user has selected the done button. */   /* The function SingleSelectFilter that is passed as an argument to */   /* ModalDialog is used to handle mouse-clicks in the list.          */   /*==================================================================*/   DoubleClickActive = TRUE;   while ((itemNumber != COMM_COMP_DIALOG_OK) &&          (itemNumber != COMM_COMP_DIALOG_CANCEL))     {       ModalDialog((ModalPtr) SingleSelectFilterRef,&itemNumber);     }   DoubleClickActive = false;   selection = PutSelectionNameInBuffer();   CleanUpAfterManagerDialog(TRUE);   if (itemNumber == COMM_COMP_DIALOG_CANCEL) return(NULL);   return(DialogBuffer);  }/*******************************************************//* UpdateCommandCompletionButtons: Updates the buttons *//* in the Command Completion dialog box.               *//*******************************************************/static void UpdateCommandCompletionButtons(dptr,selection)  DialogPtr dptr;  int selection;  {#if MAC_MPW || MAC_MCW#pragma unused(selection)#endif   Handle itemHandle;   Rect dispRect;   short int itemType;   int theSelection;   theSelection = GetSingleSelection(Choices);   /*=========================================================*/   /* Get information about the OK button dialog item. */   /*=========================================================*/   GetDItem(dptr,COMM_COMP_DIALOG_OK,&itemType,&itemHandle,&dispRect);   if (theSelection != -1)     {      HiliteControl((ControlHandle) itemHandle,ACTIVE_VALUE);      OutlineButton(ManagerDialog,COMM_COMP_DIALOG_OK,TRUE);     }   else     {      HiliteControl((ControlHandle) itemHandle,INACTIVE_VALUE);      OutlineButton(ManagerDialog,COMM_COMP_DIALOG_OK,false);     }  }/**********************************************************//* GetNextCompletion:  *//**********************************************************/void *GetNextCompletion(thePtr)  void *thePtr;  {   if (thePtr == NULL) return(GlobalMatches);   return (((struct symbolMatch *) thePtr)->next);  }/**********************************************************//* GetNextCompletion:  *//**********************************************************/char *GetCompletionName(thePtr)  void *thePtr;  {   if (thePtr == NULL) return(NULL);   return (ValueToString(((struct symbolMatch *) thePtr)->match));  }  /*************************************************//* DoPreferences: Handle Preferences... command. *//*************************************************/void DoPreferences()  {   DialogPtr dptr;   short int item_num = 0;   int oldoption2, oldoption3, oldoption4;   int oldoption5, oldoption6, oldoption7;   short int itemType;   Handle itemHandle;   Rect dispRect;   GrafPtr savePort;   EnvironmentRSRCHdl theResource;      /*=========================*/   /* Save the previous port. */   /*=========================*/   GetPort(&savePort);   /*==============================================*/   /* Get the dialog and make it the current port. */   /*==============================================*/   dptr = GetNewDialog(256,NULL,(WindowPtr) -1L);   SetPort(dptr);   CenterWindow(dptr,0.5,0.33);   ShowWindow(dptr);   /*==================================================================*/   /* Outline the OK button to indicate that it is the default button. */   /*==================================================================*/   OutlineButton(dptr,OKButton,TRUE);   /*=================================================================*/   /* Frame the two lines included in the dialog (for visual effect). */   /*=================================================================*/   PenPat(GRAY);   GetDItem(dptr,PrefsTopLine,&itemType,&itemHandle,&dispRect);   FrameRect(&dispRect);   GetDItem(dptr,PrefsBottomLine,&itemType,&itemHandle,&dispRect);   FrameRect(&dispRect);   PenPat(BLACK);   /*===============================================*/   /* The cursor for the dialog should be an arrow. */   /*===============================================*/   InitCursor();   /*==============================================*/   /* Set the check boxes to their current values. */   /*==============================================*/   oldoption2 = WarningsOption;   oldoption3 = CommandCompletionDialog;   oldoption4 = RememberEditWindowState;   oldoption5 = RememberEnvironmentWindowState;   oldoption6 = HonorEditWindowState;   oldoption7 = HonorEnvironmentWindowState;      /* SetCheckBox(dptr,WarningsCheck,WarningsOption); */   SetCheckBox(dptr,CommandCompletionCheck,CommandCompletionDialog);   SetCheckBox(dptr,RememberEditWindowStateCheck,RememberEditWindowState);   SetCheckBox(dptr,RememberEnvironmentWindowStateCheck,RememberEnvironmentWindowState);   SetCheckBox(dptr,HonorEditWindowStateCheck,HonorEditWindowState);   SetCheckBox(dptr,HonorEnvironmentWindowStateCheck,HonorEnvironmentWindowState);   /*=====================*/   /* Conduct the dialog. */   /*=====================*/   item_num = -1;   while ((item_num != OKButton) && (item_num != CancelButton))     {      ModalDialog((ModalPtr) DefaultDialogFilterRef,&item_num);      switch (item_num)        {         /*         case WarningsCheck:           WarningsOption = ToggleCheckBox(dptr,WarningsCheck);           break;         */         case CommandCompletionCheck:           CommandCompletionDialog = ToggleCheckBox(dptr,CommandCompletionCheck);           break;         case RememberEditWindowStateCheck:           RememberEditWindowState = ToggleCheckBox(dptr,RememberEditWindowStateCheck);           break;                    case RememberEnvironmentWindowStateCheck:           RememberEnvironmentWindowState = ToggleCheckBox(dptr,RememberEnvironmentWindowStateCheck);           break;                    case HonorEditWindowStateCheck:           HonorEditWindowState = ToggleCheckBox(dptr,HonorEditWindowStateCheck);           break;         case HonorEnvironmentWindowStateCheck:           HonorEnvironmentWindowState = ToggleCheckBox(dptr,HonorEnvironmentWindowStateCheck);           break;         case OKButton:           theResource = CreateEnvironmentResource(WarningsOption,                                                 CommandCompletionDialog,                                                 RememberEditWindowState,                                                 RememberEnvironmentWindowState,                                                 HonorEditWindowState,                                                 HonorEnvironmentWindowState);              RememberPreferences(environmentResType,environmentResID,(Handle) theResource);           break;         case CancelButton:           WarningsOption = oldoption2;           CommandCompletionDialog = oldoption3;           RememberEditWindowState = oldoption4;           RememberEnvironmentWindowState = oldoption5;           HonorEditWindowState = oldoption6;           HonorEnvironmentWindowState = oldoption7;           break;        }     }   /*=====================*/   /* Remove the dialog. */   /*=====================*/   DisposDialog(dptr);   /*============================*/   /* Restore the original port. */   /*============================*/   SetPort(savePort);  }