   /*******************************************************/   /*      "C" Language Integrated Production System      */   /*                                                     */   /*            Macintosh Version 3.2  05/12/93          */   /*                                                     */   /*           MACINTOSH INITIALIZATION MODULE           */   /*******************************************************//*************************************************************//* Purpose:                                                  *//*                                                           *//* Principal Programmer(s):                                  *//*      Gary D. Riley                                        *//*                                                           *//* Contributing Programmer(s):                               *//*                                                           *//* Revision History:                                         *//*                                                           *//*************************************************************/#define _MACFUNCS_SOURCE_#include <stdlib.h>#include <string.h>#include "setup.h"#include "argacces.h"#include "extnfunc.h"#include "factmngr.h"#include <Windows.h>#include <Events.h>#if MAC_MCW || MAC_SC7 || MAC_MPW || MAC_SC8#include <Printing.h>#else#include <PrintTraps.h>#endif#if MAC_MPW || MAC_MCW#include <strings.h>#else#include <pascal.h>#endif#if MAC_SC7 || MAC_SC8#define PTOCSTR P2CStr#define CTOPSTR C2PStr#else#define PTOCSTR p2cstr#define CTOPSTR c2pstr#endif#if MAC_MCW || MAC_SC8#define ModalPtr ModalFilterUPP#else#define ModalPtr ModalFilterProcPtr#endif#include "displayw.h"#include "editmenu.h"#include "window.h"#include "menucmds.h"#include "macinit.h"#include "editdlog.h"#define GENERIC_CHECKBOX_DIALOG               500#define GENERIC_RADIO_BUTTON_DIALOG           501#define GENERIC_CHECKBOX_DIALOG_OK              1#define GENERIC_CHECKBOX_DIALOG_CANCEL          2#define GENERIC_CHECKBOX_DIALOG_TITLE           3#define GENERIC_CHECKBOX_DIALOG_TOP_LINE        4#define GENERIC_CHECKBOX_DIALOG_BOTTOM_LINE     5#define GENERIC_CHECKBOX_FIRST_CHECKBOX         6#define GENERIC_CHECKBOX_LAST_CHECKBOX         17#define GENERIC_NUMBER_OF_CHECKBOXES           12#define CHECK_BOX_SIZE   25#define CHECK_BOX_HEIGHT 25#define DIALOG_SIDE_MARGIN 14/****************************************//* GLOBAL INTERNAL FUNCTION DEFINITIONS *//****************************************/   void                           DefineMacFunctions(void);   void                           ClearDisplayWindowCommand(void);   int                            SetDialogWarningsCommand(void);   int                            SetCompletionDialogCommand(void);   int                            OKCancelAlertCommand(void);   void                           CheckBoxDialogCommand(DATA_OBJECT_PTR);   void                           RadioButtonDialogCommand(DATA_OBJECT_PTR);   void                           DoCheckBoxOrRadioDialog(char *,DATA_OBJECT_PTR,int);/************************************************************//* DefineMacFunctions:                                      *//************************************************************/void DefineMacFunctions()  {#if ! RUN_TIME   DefineFunction2("clear-window",'v',                  PTIF ClearDisplayWindowCommand,                  "ClearDisplayWindowCommand", "00");   DefineFunction2("set-dialog-warnings",'b',SetDialogWarningsCommand,"SetDialogWarningsCommand", "11");   DefineFunction2("set-completion-dialog",'b',SetCompletionDialogCommand,"SetCompletionDialogCommand", "11");   DefineFunction2("ok-cancel-alert",'b',OKCancelAlertCommand,"OKCancelAlertCommand", "11s");   DefineFunction2("checkbox-dialog",'u',PTIF CheckBoxDialogCommand,"CheckBoxDialogCommand", "23*smm");   DefineFunction2("radio-button-dialog",'u',PTIF RadioButtonDialogCommand,"RadioButtonDialogCommand", "23*smi");#endif  }/************************************************************//* OKCancelAlertCommand:                                    *//************************************************************/int OKCancelAlertCommand()  {   DATA_OBJECT argPtr;   char *tempStr;   int rv;   if (ArgCountCheck("ok-cancel-alert",EXACTLY,1) == -1)     { return(FALSE); }   if (ArgTypeCheck("ok-cancel-alert",1,STRING,&argPtr) == FALSE)     { return(FALSE); }   tempStr = malloc(strlen(DOToString(argPtr)) + 1);   strcpy(tempStr,DOToString(argPtr));   CTOPSTR((char *) tempStr);   rv = OKCancelAlertDialog((StringPtr) tempStr);   free(tempStr);   return(rv);  }/*******************************************//* ClearDisplayWindowCommand: H/L access   *//*   routine for the clear-window command. *//*******************************************/void ClearDisplayWindowCommand()  {   if (ArgCountCheck("clear-window",EXACTLY,0) == -1) return;   ClearDisplayWindow();  }/************************************************//* SetDialogWarningsCommand: H/L access routine *//*   for the set-dialog-warnings command.       *//************************************************/int SetDialogWarningsCommand()  {   int oldValue;   DATA_OBJECT argPtr;   oldValue = WarningsOption;   if (ArgCountCheck("set-dialog-warnings",EXACTLY,1) == -1)     { return(oldValue); }   RtnUnknown(1,&argPtr);   if ((argPtr.value == CLIPSFalseSymbol) && (argPtr.type == SYMBOL))     { WarningsOption = FALSE; }   else     { WarningsOption = TRUE; }   return(oldValue);  }  /************************************************************//* SetCompletionDialogCommand:                                   *//************************************************************/int SetCompletionDialogCommand()  {   int oldValue;   DATA_OBJECT argPtr;   oldValue = CommandCompletionDialog;   if (ArgCountCheck("set-completion-dialog",EXACTLY,1) == -1)     { return(oldValue); }   RtnUnknown(1,&argPtr);   if ((argPtr.value == CLIPSFalseSymbol) && (argPtr.type == SYMBOL))     { CommandCompletionDialog = FALSE; }   else     { CommandCompletionDialog = TRUE; }   return(oldValue);  }/************************************************************//* CheckBoxDialogCommand:                                   *//************************************************************/void CheckBoxDialogCommand(returnValue)  DATA_OBJECT_PTR returnValue;  {   DoCheckBoxOrRadioDialog("checkbox-dialog",returnValue,false);  }/************************************************************//* RadioButtonDialogCommand:                                   *//************************************************************/void RadioButtonDialogCommand(returnValue)  DATA_OBJECT_PTR returnValue;  {   DoCheckBoxOrRadioDialog("radio-button-dialog",returnValue,TRUE);  }/************************************************************//* CheckBoxDialogCommand:                                   *//************************************************************/void DoCheckBoxOrRadioDialog(whichFunction,returnValue,radioButtons)  char *whichFunction;  DATA_OBJECT_PTR returnValue;  int radioButtons;  {   DialogPtr dptr;   short int itemNumber = 0;   short int itemType;   Handle itemHandle;   Rect dispRect;   GrafPtr savePort;   int ov;   int i, j;   int numberOfCheckBoxes;   int type;   int count;   Str255 theString;   char *tempStr;   DATA_OBJECT argPtr1, argPtr2, argPtr3;   void *checkBoxStrings[GENERIC_NUMBER_OF_CHECKBOXES];   int checkBoxType[GENERIC_NUMBER_OF_CHECKBOXES];   VOID *multifieldPtr;   int titleSize, leftSize, rightSize;   int hsize, vsize;   int max, width, emptySpaceDeleted;   int argCount;   /*====================================*/   /* Set default return value to FALSE. */   /*====================================*/   SetpType(returnValue,SYMBOL);   SetpValue(returnValue,CLIPSFalseSymbol);   /*=================================================*/   /* Check the correct number and type of arguments. */   /*=================================================*/   if ((argCount = ArgRangeCheck(whichFunction,2,3)) == -1) return;   if (ArgTypeCheck(whichFunction,1,STRING,&argPtr1) == FALSE) return;   if (ArgTypeCheck(whichFunction,2,MULTIFIELD,&argPtr2) == FALSE) return;   if (argCount == 3)     {      if (radioButtons)        {         if (ArgTypeCheck(whichFunction,3,INTEGER,&argPtr3) == FALSE) return;        }      else        {         if (ArgTypeCheck(whichFunction,3,MULTIFIELD,&argPtr3) == FALSE) return;        }     }   /*==========================================*/   /* Determine the number of values stored in */   /* the 2nd multifield argument.             */   /*==========================================*/   numberOfCheckBoxes = GetDOLength(argPtr2);   if (numberOfCheckBoxes > GENERIC_NUMBER_OF_CHECKBOXES)     {      /* Call the List Dialog routines. */      return;     }   /*========================================================*/   /* Save the values stored in the 2nd multifield argument. */   /* While doing so, make sure they are lexemes.            */   /*========================================================*/   multifieldPtr = GetValue(argPtr2);   for (i = 0, j = GetDOBegin(argPtr2); i < numberOfCheckBoxes; i++, j++)     {      type = GetMFType(multifieldPtr,j);      if ((type == STRING) || (type == SYMBOL))        {         checkBoxType[i] = type;         checkBoxStrings[i] = GetMFValue(multifieldPtr,j);        }      else        {         ExpectedTypeError1("checkbox-dialog",2,"multifield containing only lexemes");         return;        }     }   /*=========================*/   /* Save the previous port. */   /*=========================*/   GetPort(&savePort);   /*==============================================*/   /* Get the dialog and make it the current port. */   /*==============================================*/   if (radioButtons) dptr = GetNewDialog(GENERIC_RADIO_BUTTON_DIALOG,NULL,(WindowPtr) -1L);   else dptr = GetNewDialog(GENERIC_CHECKBOX_DIALOG,NULL,(WindowPtr) -1L);   SetPort(dptr);   /*======================================================*/   /* Determine size and placement of items in the dialog. */   /*======================================================*/   titleSize = TextWidth(DOToString(argPtr1),0,strlen(DOToString(argPtr1)));   leftSize = 0;   max = GENERIC_NUMBER_OF_CHECKBOXES / 2;   if (max > numberOfCheckBoxes) max = numberOfCheckBoxes;   for (i = 0 ; i < max; i++)     {      tempStr = ValueToString(checkBoxStrings[i]);      count = TextWidth(tempStr,0,strlen(tempStr));      if (count > leftSize) leftSize = count;     }   rightSize = 0;   max = GENERIC_NUMBER_OF_CHECKBOXES;   if (max > numberOfCheckBoxes) max = numberOfCheckBoxes;   for (i = (GENERIC_NUMBER_OF_CHECKBOXES / 2); i < max; i++)     {      tempStr = ValueToString(checkBoxStrings[i]);      count = TextWidth(tempStr,0,strlen(tempStr));      if (count > rightSize) rightSize = count;     }   if (((rightSize + leftSize + 80) > GetWorkingScreenWidth()) ||       ((titleSize + 80) > GetWorkingScreenWidth()))     {      /* Call the List Dialog routines. */      DisposDialog(dptr);      SetPort(savePort);      return;     }   /*=========================*/   /* Disable Cursor Updates. */   /*=========================*/   ov = GetUpdateCursorFlag();   SetUpdateCursorFlag(false);   /*===========================================*/   /* Determine the current size of the dialog. */   /*===========================================*/   hsize = (*dptr).portRect.right - (*dptr).portRect.left;   vsize = (*dptr).portRect.bottom - (*dptr).portRect.top;   hsize = leftSize + rightSize + CHECK_BOX_SIZE + (2 * DIALOG_SIDE_MARGIN);   if (numberOfCheckBoxes > (GENERIC_NUMBER_OF_CHECKBOXES / 2)) hsize += CHECK_BOX_SIZE + 10;   if (hsize < titleSize) hsize = titleSize + 10;   if (hsize < 150) hsize = 150;   /*=================================================*/   /* Move the check boxes to the appropriate places. */   /*=================================================*/   if (numberOfCheckBoxes <= (GENERIC_NUMBER_OF_CHECKBOXES / 2))     {      emptySpaceDeleted = CHECK_BOX_HEIGHT *                          ((GENERIC_NUMBER_OF_CHECKBOXES / 2) - numberOfCheckBoxes);      vsize -= emptySpaceDeleted;      for (i = 0; i < numberOfCheckBoxes; i++)        {         GetDItem(dptr,GENERIC_CHECKBOX_FIRST_CHECKBOX + i,&itemType,&itemHandle,&dispRect);         dispRect.left = (hsize - (leftSize + CHECK_BOX_SIZE)) / 2;         dispRect.right = dispRect.left + leftSize + CHECK_BOX_SIZE;         SizeControl((ControlHandle) itemHandle,leftSize + CHECK_BOX_SIZE,CHECK_BOX_HEIGHT);         MoveControl((ControlHandle) itemHandle,dispRect.left,dispRect.top);         SetDItem(dptr,GENERIC_CHECKBOX_FIRST_CHECKBOX + i,itemType,itemHandle,&dispRect);        }     }   else     {      emptySpaceDeleted = 0;      for (i = 0; i < (GENERIC_NUMBER_OF_CHECKBOXES / 2); i++)        {         GetDItem(dptr,GENERIC_CHECKBOX_FIRST_CHECKBOX + i,&itemType,&itemHandle,&dispRect);         dispRect.left = DIALOG_SIDE_MARGIN;         dispRect.right = dispRect.left + leftSize + CHECK_BOX_SIZE;         SizeControl((ControlHandle) itemHandle,leftSize + CHECK_BOX_SIZE,CHECK_BOX_HEIGHT);         MoveControl((ControlHandle) itemHandle,dispRect.left,dispRect.top);         SetDItem(dptr,GENERIC_CHECKBOX_FIRST_CHECKBOX + i,itemType,itemHandle,&dispRect);        }      for (i = (GENERIC_NUMBER_OF_CHECKBOXES / 2); i < numberOfCheckBoxes; i++)        {         GetDItem(dptr,GENERIC_CHECKBOX_FIRST_CHECKBOX + i,&itemType,&itemHandle,&dispRect);         dispRect.left = DIALOG_SIDE_MARGIN + leftSize + CHECK_BOX_SIZE + 10;         dispRect.right = dispRect.left + rightSize + CHECK_BOX_SIZE;         SizeControl((ControlHandle) itemHandle,rightSize + CHECK_BOX_SIZE,CHECK_BOX_HEIGHT);         MoveControl((ControlHandle) itemHandle,dispRect.left,dispRect.top);         SetDItem(dptr,GENERIC_CHECKBOX_FIRST_CHECKBOX + i,itemType,itemHandle,&dispRect);        }     }   /*======================================================*/   /* Center the OK and CANCEL buttons and move them up if */   /* there aren't enough check boxes to fill the dialog.  */   /*======================================================*/   GetDItem(dptr,GENERIC_CHECKBOX_DIALOG_OK,&itemType,&itemHandle,&dispRect);   width = dispRect.right - dispRect.left;   dispRect.top -= emptySpaceDeleted;   dispRect.bottom -= emptySpaceDeleted;   dispRect.left = (hsize / 2) + 7;   dispRect.right = dispRect.left + width;   MoveControl((ControlHandle) itemHandle,dispRect.left,dispRect.top);   SetDItem(dptr,GENERIC_CHECKBOX_DIALOG_OK,itemType,itemHandle,&dispRect);   GetDItem(dptr,GENERIC_CHECKBOX_DIALOG_CANCEL,&itemType,&itemHandle,&dispRect);   width = dispRect.right - dispRect.left;   dispRect.top -= emptySpaceDeleted;   dispRect.bottom -= emptySpaceDeleted;   dispRect.right = (hsize / 2) - 7;   dispRect.left = dispRect.right - width;   MoveControl((ControlHandle) itemHandle,dispRect.left,dispRect.top);   SetDItem(dptr,GENERIC_CHECKBOX_DIALOG_CANCEL,itemType,itemHandle,&dispRect);   /*===========================================================*/   /* Update Top and Bottom Line Lengths. Move the bottom line  */   /* up if there aren't enough check boxes to fill the dialog. */   /*===========================================================*/   GetDItem(dptr,GENERIC_CHECKBOX_DIALOG_TOP_LINE,&itemType,&itemHandle,&dispRect);   dispRect.left = DIALOG_SIDE_MARGIN - 5;   dispRect.right = hsize - (DIALOG_SIDE_MARGIN - 5);   SetDItem(dptr,GENERIC_CHECKBOX_DIALOG_TOP_LINE,itemType,itemHandle,&dispRect);   GetDItem(dptr,GENERIC_CHECKBOX_DIALOG_BOTTOM_LINE,&itemType,&itemHandle,&dispRect);   dispRect.top -= emptySpaceDeleted;   dispRect.bottom -= emptySpaceDeleted;   dispRect.left = DIALOG_SIDE_MARGIN - 5;   dispRect.right = hsize - (DIALOG_SIDE_MARGIN - 5);   SetDItem(dptr,GENERIC_CHECKBOX_DIALOG_BOTTOM_LINE,itemType,itemHandle,&dispRect);   /*====================*/   /* Resize the dialog. */   /*====================*/   SizeWindow(dptr,hsize,vsize,false);   /*====================*/   /* Center the window. */   /*====================*/   CenterWindow(dptr,0.5,0.33);   /*===============================================*/   /* Set up the update routines for various items. */   /*===============================================*/   GetDItem(dptr,GENERIC_CHECKBOX_DIALOG_TOP_LINE,&itemType,&itemHandle,&dispRect);   SetDItem(dptr,GENERIC_CHECKBOX_DIALOG_TOP_LINE,itemType,(Handle) DefaultDialogLineUpdateRoutineRef,&dispRect);   GetDItem(dptr,GENERIC_CHECKBOX_DIALOG_BOTTOM_LINE,&itemType,&itemHandle,&dispRect);   SetDItem(dptr,GENERIC_CHECKBOX_DIALOG_BOTTOM_LINE,itemType,(Handle) DefaultDialogLineUpdateRoutineRef,&dispRect);   /*=========================*/   /* Set the window's Title. */   /*=========================*/   strncpy((char *) theString,DOToString(argPtr1),254);   CTOPSTR((char *) theString);   GetDItem(dptr,GENERIC_CHECKBOX_DIALOG_TITLE,&itemType,&itemHandle,&dispRect);   SetIText(itemHandle,theString);   PlaceDialogTextItem(dptr,GENERIC_CHECKBOX_DIALOG_TITLE,TRUE);   /*=========================*/   /* Set up the check boxes. */   /*=========================*/   for (i = 0; i < numberOfCheckBoxes; i++)     {      strncpy((char *) theString,ValueToString(checkBoxStrings[i]),254);      CTOPSTR((char *) theString);      GetDItem(dptr,GENERIC_CHECKBOX_FIRST_CHECKBOX + i,&itemType,&itemHandle,&dispRect);      SetCTitle((ControlHandle) itemHandle,theString);     }   for (i = numberOfCheckBoxes; i < GENERIC_NUMBER_OF_CHECKBOXES; i++)     { HideDItem(dptr,GENERIC_CHECKBOX_FIRST_CHECKBOX + i); }   /*=================================================*/   /* Select the default radio buttons or checkboxes. */   /*=================================================*/   if (argCount == 2)     {      if (radioButtons) SetRadioBank(dptr,GENERIC_CHECKBOX_FIRST_CHECKBOX,                                          GENERIC_CHECKBOX_FIRST_CHECKBOX,                                          GENERIC_CHECKBOX_LAST_CHECKBOX);     }   else     {      if (radioButtons)        {         int whichOne;         whichOne = DOToInteger(argPtr3);         if ((whichOne < 1) || (whichOne > numberOfCheckBoxes)) whichOne = 1;         SetRadioBank(dptr,GENERIC_CHECKBOX_FIRST_CHECKBOX + whichOne - 1,                           GENERIC_CHECKBOX_FIRST_CHECKBOX,                           GENERIC_CHECKBOX_LAST_CHECKBOX);        }      else        {         /* Do nothing right now. */        }     }   /*==================*/   /* Show the dialog. */   /*==================*/   ShowWindow(dptr);   /*==================================================================*/   /* Outline the OK button to indicate that it is the default button. */   /*==================================================================*/   OutlineButton(dptr,GENERIC_CHECKBOX_DIALOG_OK,TRUE);   /*===============================================*/   /* The cursor for the dialog should be an arrow. */   /*===============================================*/   InitCursor();   /*=====================*/   /* Conduct the dialog. */   /*=====================*/   itemNumber = -1;   while ((itemNumber != GENERIC_CHECKBOX_DIALOG_OK) &&          (itemNumber != GENERIC_CHECKBOX_DIALOG_CANCEL))     {      ModalDialog((ModalPtr) DefaultDialogFilterRef,&itemNumber);      switch (itemNumber)        {         case GENERIC_CHECKBOX_DIALOG_OK:           count = 0;           for (i = 0; i < numberOfCheckBoxes; i++)              {               GetDItem(dptr,GENERIC_CHECKBOX_FIRST_CHECKBOX + i,&itemType,&itemHandle,&dispRect);               if (GetCtlValue((ControlHandle) itemHandle)) count++;               else checkBoxType[i] = -1;              }           multifieldPtr = CreateMultifield((long) count);           for (i = 0, j = 1; i < numberOfCheckBoxes; i++)              {               if (checkBoxType[i] != -1)                 {                  SetMFType(multifieldPtr,j,checkBoxType[i]);                  SetMFValue(multifieldPtr,j,checkBoxStrings[i]);                  j++;                 }              }           SetpType(returnValue,MULTIFIELD);           SetpValue(returnValue,multifieldPtr);           SetpDOBegin(returnValue,1);           SetpDOEnd(returnValue,count);           break;         case GENERIC_CHECKBOX_DIALOG_CANCEL:           break;         default:           if (radioButtons) SetRadioBank(dptr,itemNumber,GENERIC_CHECKBOX_FIRST_CHECKBOX,GENERIC_CHECKBOX_LAST_CHECKBOX);           else ToggleCheckBox(dptr,itemNumber);           break;        }     }   /*=====================*/   /* Remove the dialog. */   /*=====================*/   DisposDialog(dptr);   /*============================*/   /* Restore the original port. */   /*============================*/   SetPort(savePort);   SetUpdateCursorFlag(ov);  }