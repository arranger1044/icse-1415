   /*******************************************************/   /*      "C" Language Integrated Production System      */   /*                                                     */   /*            Macintosh Version 3.2  05/12/93          */   /*                                                     */   /*                    PRINT MODULE                     */   /*******************************************************//*************************************************************//* Purpose:                                                  *//*                                                           *//* Principal Programmer(s):                                  *//*      Gary D. Riley                                        *//*                                                           *//* Contributing Programmer(s):                               *//*                                                           *//* Revision History:                                         *//*                                                           *//*************************************************************/#define _PRINT_SOURCE_#include "setup.h"#include <stddef.h>#include <Memory.h>#if MAC_MCW || MAC_SC7 || MAC_MPW || MAC_SC8#include <Printing.h>#else#include <PrintTraps.h>#endif#include <Menus.h>#include <Events.h>#include <Controls.h>#include <OSUtils.h>#include "print.h"#include "stnrdmac.h"#include "window.h"/***************************************//* LOCAL INTERNAL FUNCTION DEFINITIONS *//***************************************/   static void                   CheckPrintRecord(void);/***************************************//* LOCAL INTERNAL VARIABLE DEFINITIONS *//***************************************/   static THPrint          hPrint = NULL;/**********************************************//* CHECKPRINTRECORD: Allocates a print record *//*   if one does not already exist.           *//**********************************************/static void CheckPrintRecord()  {   /*===========================================*/   /* If a print record already exists, return. */   /*===========================================*/   if (hPrint != NULL) return;   /*==============================*/   /* Allocate a new print record. */   /*==============================*/   hPrint = (TPrint **) NewHandle((Size) sizeof( TPrint ));  /*=============================================*/  /* Fill the fields of the print record hPrint  */  /* with the default values that are stored in  */  /* the printer resource file.                  */  /*=============================================*/   PrintDefault(hPrint);  }/**********************************************//* DOPAGESETUP: Handle Page Setup... command. *//**********************************************/void DoPageSetup()  {   /*====================================*/   /* Open the printing manager for use. */   /*====================================*/   PrOpen();   /*============================================*/   /* Create print record if one does not exist. */   /*============================================*/   CheckPrintRecord();   /*===================================================*/   /* Conduct a style dialog with the user to determine */   /* the page dimensions and other information needed  */   /* for page setup. The initial settings displayed in */   /* the dialog box are taken from the most recent     */   /* print record. Returns TRUE and saves the results  */   /* in the print record hPrint if the user confirms   */   /* the dialog. Otherwise returns FALSE.              */   /*===================================================*/   WindowActivate(FrontWindow(),false,false);   PrStlDialog(hPrint);   /*=============================*/   /* Close the printing manager. */   /*=============================*/   PrClose();  }/*************************************//* DOPRINT: Handle Print... command. *//*************************************/void DoPrint(whichWindow)  WindowPtr whichWindow;  {   GrafPtr savePort;   TPrStatus prStatus;   int copies;   WDHandle theData;   Handle dataHandle;   void (*myPrintRoutine)(THPrint,WindowPtr);   /*=================================*/   /* Get the window's print routine. */   /*=================================*/   dataHandle = (Handle) GetWRefCon(whichWindow);   theData = (WDHandle) dataHandle;   myPrintRoutine = (**theData).printRoutine;   if (myPrintRoutine == NULL)     {      SysBeep(10);      return;     }   /*====================================*/   /* Open the printing manager for use. */   /*====================================*/   PrOpen();   /*============================================*/   /* Create print record if one does not exist. */   /*============================================*/   CheckPrintRecord();   /*=================================================*/   /* Restore normal cursor before displaying dialog. */   /*=================================================*/   InitCursor();   /*=====================================================*/   /* Conduct a job dialog with the user to determine the */   /* print quality, range of pages to print, and so on.  */   /* If the user cancels the print command, then close   */   /* the Printing Manager.                               */   /*=====================================================*/   WindowActivate(FrontWindow(),false,false);   if (PrJobDialog(hPrint) == 0)     {      PrClose();      return;     }   /*===================================*/   /* Indicate delay with watch cursor. */   /*===================================*/   SetCursor(*WatchCursor);   /*========================*/   /* Save the current port. */   /*========================*/   GetPort(&savePort);   /*============================================*/   /* Determine the number of copies to be made. */   /*============================================*/   if ( (**hPrint).prJob.bJDocLoop == bDraftLoop)     { copies = (**hPrint).prJob.iCopies; }   else     { copies = 1; }   /*==================*/   /* Print each copy. */   /*==================*/   for ( ; copies > 0 ; copies--)     {      if (myPrintRoutine != NULL)        {         (*myPrintRoutine)(hPrint,whichWindow);         PrPicFile(hPrint,0L,0L,0L,&prStatus);        }     }   /*============================*/   /* Restore the original port. */   /*============================*/   SetPort((GrafPtr) savePort);   /*=============================*/   /* Close the Printing Manager. */   /*=============================*/   PrClose();  }