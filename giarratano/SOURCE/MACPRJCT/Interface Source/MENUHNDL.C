   /*******************************************************/   /*      "C" Language Integrated Production System      */   /*                                                     */   /*            Macintosh Version 3.2  05/12/93          */   /*                                                     */   /*                    MENUS MODULE                     */   /*******************************************************//*************************************************************//* Purpose:                                                  *//*                                                           *//* Principal Programmer(s):                                  *//*      Gary D. Riley                                        *//*                                                           *//* Contributing Programmer(s):                               *//*                                                           *//* Revision History:                                         *//*                                                           *//*************************************************************/#define _MENUHNDL_SOURCE_#include "setup.h"#include "stnrdmac.h"#include <stddef.h>#include <stdlib.h>#include <Menus.h>#include <ToolUtils.h>#if MAC_SC7 || MAC_MPW || MAC_MCW || MAC_SC8#define BLACK (&qd.black)#else#define BLACK (qd.black)#endif#include "menuhndl.h"#include "window.h"/**************//* Structures *//**************/struct menuItem  {   MenuHandle thisMenu;   int thisItem;   int standardItem;   struct menuItem *next;  };/****************************************//* GLOBAL INTERNAL VARIABLE DEFINITIONS *//****************************************/   static struct menuItem   *ListOfMenus = NULL;   static struct menuItem   *StandardMenuItems = NULL;   static void             (*ApplicationMenuUpdateRoutine)(WindowPtr,EventRecord *,int) = NULL;/***************************************************//* RegisterMenu: Adds a menu to the list of menus. *//***************************************************/void RegisterMenu(whichMenu)  MenuHandle whichMenu;  {   struct menuItem *tempPtr;   tempPtr = malloc(sizeof(struct menuItem));   tempPtr->next = ListOfMenus;   tempPtr->thisMenu = whichMenu;   ListOfMenus = tempPtr;  }/***************************************************//* RegisterStandardMenuItem: *//***************************************************/void RegisterStandardMenuItem(whichMenu,theItem,standardItem)  MenuHandle whichMenu;  int theItem, standardItem;  {   struct menuItem *tempPtr;   tempPtr = malloc(sizeof(struct menuItem));   tempPtr->next = StandardMenuItems;   tempPtr->thisMenu = whichMenu;   tempPtr->thisItem = theItem;   tempPtr->standardItem = standardItem;   StandardMenuItems = tempPtr;  }/***********************************************//* EnableStandardMenuItem:  *//***********************************************/void EnableStandardMenuItem(whichOne)  int whichOne;  {   struct menuItem *tempPtr;   tempPtr = StandardMenuItems;   while (tempPtr != NULL)     {      if (tempPtr->standardItem == whichOne)        {         EnableItem(tempPtr->thisMenu,tempPtr->thisItem);         return;        }      tempPtr = tempPtr->next;     }  }/***********************************************//* DisableStandardMenuItem:  *//***********************************************/void DisableStandardMenuItem(whichOne)  int whichOne;  {   struct menuItem *tempPtr;   tempPtr = StandardMenuItems;   while (tempPtr != NULL)     {      if (tempPtr->standardItem == whichOne)        {         DisableItem(tempPtr->thisMenu,tempPtr->thisItem);         return;        }      tempPtr = tempPtr->next;     }       }/***********************************************//* SetStandardMenuItem:  *//***********************************************/void SetStandardMenuItem(whichOne,pStr)  int whichOne;  StringPtr pStr;  {   struct menuItem *tempPtr;   tempPtr = StandardMenuItems;   while (tempPtr != NULL)     {      if (tempPtr->standardItem == whichOne)        {         SetItem(tempPtr->thisMenu,tempPtr->thisItem,pStr);         return;        }      tempPtr = tempPtr->next;     }  }/***********************************************//* DimAllMenuItems: Dims all registered menus. *//***********************************************/void DimAllMenuItems()  {   struct menuItem *tempPtr;   int numberOfItems, i;   short theChar;      SetStandardMenuItem(STANDARD_MENU_ITEM_UNDO,(StringPtr) "\pUndo");   tempPtr = ListOfMenus;   while (tempPtr != NULL)     {      numberOfItems = CountMItems(tempPtr->thisMenu);      for (i = 1; i <= numberOfItems; i++)        {          DisableItem(tempPtr->thisMenu,i);                  /* Disable the check mark for non-hierarchical menus. */         GetItemCmd(tempPtr->thisMenu,i,&theChar);         if (theChar != 0x001B) CheckItem(tempPtr->thisMenu,i,false);        }      tempPtr = tempPtr->next;     }   }/***********************************************//* SetApplicationMenuUpdateRoutine:  *//***********************************************/void SetApplicationMenuUpdateRoutine(whichFunction)  void (*whichFunction)(WindowPtr,EventRecord *,int);  {   ApplicationMenuUpdateRoutine = whichFunction;  }/***********************************************//* UpdateMenuBar:  *//***********************************************/void UpdateMenuBar(myEvent)  EventRecord *myEvent;  {   WindowPtr whichWindow;   WDHandle theData;   Handle dataHandle;   void (*myMenuUpdateRoutine)(WindowPtr);   /*============================*/   /* Dim all of the menu items. */   /*============================*/   DimAllMenuItems();   /*============================================*/   /* Perform application specific menu updates. */   /*============================================*/   whichWindow = FrontWindow();   if (ApplicationMenuUpdateRoutine != NULL)     { (*ApplicationMenuUpdateRoutine)(whichWindow,myEvent,PRE_MENU_UPDATE); }   /*=======================================*/   /* Perform window specific menu updates. */   /*=======================================*/   if (whichWindow == NULL)     {      if (ApplicationMenuUpdateRoutine != NULL)        { (*ApplicationMenuUpdateRoutine)(whichWindow,myEvent,POST_MENU_UPDATE); }      return;     }   if (((WindowPeek) whichWindow)->windowKind >= userKind)     {      dataHandle = (Handle) GetWRefCon(whichWindow);      theData = (WDHandle) dataHandle;      myMenuUpdateRoutine = (**theData).menuUpdateRoutine;      if (myMenuUpdateRoutine != NULL) (*myMenuUpdateRoutine)(whichWindow);     }   else     {      SetStandardMenuItem(STANDARD_MENU_ITEM_UNDO,(StringPtr) "\pUndo");      EnableStandardMenuItem(STANDARD_MENU_ITEM_CLOSE);      EnableStandardMenuItem(STANDARD_MENU_ITEM_UNDO);      EnableStandardMenuItem(STANDARD_MENU_ITEM_CUT);      EnableStandardMenuItem(STANDARD_MENU_ITEM_COPY);      EnableStandardMenuItem(STANDARD_MENU_ITEM_PASTE);      EnableStandardMenuItem(STANDARD_MENU_ITEM_CLEAR);     }   /*============================================*/   /* Perform application specific menu updates. */   /*============================================*/   if (ApplicationMenuUpdateRoutine != NULL)     { (*ApplicationMenuUpdateRoutine)(whichWindow,myEvent,POST_MENU_UPDATE); }  }/***********************************************//* DrawPopupMenu:  *//***********************************************/void DrawPopupMenu(theMenu,currentSelection,theDialog,theDialogItem,drawArrow)   MenuHandle theMenu;   int currentSelection;   DialogPtr theDialog;   int theDialogItem;   int drawArrow;   {    short int type;    Handle item;    Rect theRect;    WindowPtr oldPort;    Str255 currentSelectionName;    PolyHandle triPoly;    GetPort(&oldPort);    SetPort(theDialog);    PenSize(1,1);    GetItem(theMenu,currentSelection,currentSelectionName);    GetDItem(theDialog,theDialogItem,&type,&item,&theRect);    /*==========================================================*/    /* Add additional space required for the popup menus width. */    /*==========================================================*/    CalcMenuSize(theMenu);    theRect.right = theRect.left + (**theMenu).menuWidth + 1;    theRect.left -= 1;    theRect.top -= 1;    theRect.bottom +=1;    EraseRect(&theRect);    FrameRect(&theRect);    /*========================================*/    /* Draw the shadowing for the popup menu. */    /*========================================*/    MoveTo(theRect.left + 3, theRect.bottom);    LineTo(theRect.right, theRect.bottom);    LineTo(theRect.right, theRect.top + 3);    /*==========================================================*/    /* Create the downward triangle to place in the popup menu, */    /* then draw the triangle in the popup menu.                */    /*==========================================================*/    if (drawArrow)      {       triPoly = OpenPoly();       MoveTo(0,0);       LineTo(12,0);       LineTo(6,6);       LineTo(0,0);       ClosePoly();       OffsetPoly(triPoly,theRect.right - 17,theRect.top + 6);       FillPoly(triPoly,BLACK);       KillPoly(triPoly);      }    /*===============================================*/    /* Draw the current selection in the popup menu. */    /*===============================================*/    MoveTo(theRect.left + 15, theRect.bottom - 5);    DrawString(currentSelectionName);    /* Reset the user item so that it matches where the menu is placed. */    theRect.left += 1;    theRect.right -= 1;    theRect.top += 1;    theRect.bottom -=1;    SetDItem(theDialog,theDialogItem,type,item,&theRect);    /*=======================*/    /* Restore the old port. */    /*=======================*/    SetPort(oldPort);   }/***********************************************//* DoPopupMenu:  *//***********************************************/int DoPopupMenu(theMenu,currentSelection,theDialog,theTextItem,theUserItem)   MenuHandle theMenu;   int currentSelection;   DialogPtr theDialog;   int theTextItem;   int theUserItem;   {    long theChoice;    Point thePoint;    short int type;    Handle item;    Rect theBox;    Rect labelRect;    WindowPtr oldPort;   /*=======================================================*/   /* Save the old port. Set the port to the dialog window. */   /*=======================================================*/    GetPort(&oldPort);    SetPort(theDialog);    GetDItem(theDialog,theUserItem, &type, &item, &theBox);    if (theTextItem >= 0)      {       GetDItem(theDialog,theTextItem, &type, &item, &labelRect);       labelRect.left -= 2;       labelRect.top    = theBox.top;       labelRect.right  = theBox.left;       labelRect.bottom = theBox.bottom;       InvertRect(&labelRect);      }    thePoint.v = theBox.top;    thePoint.h = theBox.left;    LocalToGlobal(&thePoint);    CheckItem(theMenu,currentSelection,TRUE);    theChoice = PopUpMenuSelect(theMenu,thePoint.v,thePoint.h,currentSelection);    if (theTextItem >= 0) InvertRect(&labelRect);    CheckItem(theMenu,currentSelection,false);   /*=======================*/   /* Restore the old port. */   /*=======================*/    SetPort(oldPort);    if (HiWord(theChoice) == 0) return(currentSelection);    return(LoWord(theChoice));   }   