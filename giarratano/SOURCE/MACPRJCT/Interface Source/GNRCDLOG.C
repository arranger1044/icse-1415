   /*******************************************************/   /*      "C" Language Integrated Production System      */   /*                                                     */   /*             Macintosh Version 3.3  04/02/96         */   /*                                                     */   /*           DEFGENERIC DIALOG MANAGER MODULE          */   /*******************************************************//*************************************************************//* Purpose:                                                  *//*                                                           *//* Principal Programmer(s):                                  *//*      Gary D. Riley                                        *//*                                                           *//* Contributing Programmer(s):                               *//*                                                           *//* Revision History:                                         *//*                                                           *//*************************************************************/#define _GNRCDLOG_SOURCE_#include "setup.h"#if DEFGENERIC_CONSTRUCT#include <string.h>#include <stdlib.h>#include <Dialogs.h>#if MAC_MPW || MAC_MCW#include <strings.h>#else#include <pascal.h>#endif#if MAC_SC7 || MAC_SC8#define CTOPSTR C2PStr#else#define CTOPSTR c2pstr#endif#if MAC_SC7 || MAC_MCW || MAC_SC8#define ClickPtr ListClickLoopUPP#else#define ClickPtr ProcPtr#endif#if MAC_MCW || MAC_SC8#define ModalPtr ModalFilterUPP#else#define ModalPtr ModalFilterProcPtr#endif#include "router.h"#include "commline.h"#include "genrccom.h"#include "dlogmngr.h"#include "window.h"#include "stnrdmac.h" #include "gnrcdlog.h"/***************************************//* LOCAL INTERNAL FUNCTION DEFINITIONS *//***************************************/   static void                   UpdateDefgenericButtons(DialogPtr,int);   static void                   UpdateMethodButtons(DialogPtr,int);   static void                   DoDefmethodManager(void);   static int                    GetIndexedMethod(int);   static char                  *GetMTName1(VOID *);   static char                  *GetMTName2(VOID *);   static VOID                  *GetNextMT(VOID *);   static void                  *FindMT(int);   static char                  *GetMTPPForm(void *);   static int                    DeleteMT(void *);/***************************************//* LOCAL INTERNAL VARIABLE DEFINITIONS *//***************************************/   static void                  *GenericPtr;/**************************************************************//* DoDefgenericManager: Handle Defgeneric Manager... command. *//**************************************************************/void DoDefgenericManager()  {   short int itemNumber = 0;   int selection;   int numberOfDefgenerics;   short int itemType;   Handle itemHandle;   Rect dispRect;   CreateDialogManager(DEFGENERIC_DIALOG_RESOURCE_NUMBER,TRUE);   numberOfDefgenerics = PrepManager(DEFGENERIC_DIALOG_SELECT,                                      GetNextDefgeneric,                                      (char *(*)(VOID *)) GetConstructNameString,TRUE,false,(StringPtr) "\p");   /*================================================================*/   /* Define a ClikLoop function to be called repeatedly as long as  */   /* the mouse button is held down inside the generic list. This    */   /* loop will update the methods... button for the currently       */   /* selected generic.                                              */   /*================================================================*/   UpdateConstructManagerButtonsFunction = UpdateDefgenericButtons;   (*Choices)->lClickLoop = (ClickPtr) DefaultConstructManagerClikloopRef;   /*===========================================================*/   /* Set a global variable indicating which item in the dialog */   /* box is the list. This global value will be used by the    */   /* filter function for the dialog box.                       */   /*===========================================================*/   SelectItem = DEFGENERIC_DIALOG_SELECT;   /*====================================================*/   /* Initialize the last dialog item selected variable. */   /*====================================================*/   itemNumber = DEFGENERIC_DIALOG_SELECT;   selection = PutSelectionNameInBuffer();   /*====================================================================*/   /* Outline the Done button to indicate that it is the default button. */   /*====================================================================*/   OutlineButton(ManagerDialog,DEFGENERIC_DIALOG_DONE,TRUE);   /*========================================================*/   /* Update the method... button for the current selection. */   /*========================================================*/   UpdateDefgenericButtons(ManagerDialog,selection);   /*==================================================================*/   /* Remain in this loop until the user has selected the done button. */   /* The function SingleSelectFilter that is passed as an argument to */   /* ModalDialog is used to handle mouse-clicks in the list.          */   /*==================================================================*/   while (itemNumber != DEFGENERIC_DIALOG_DONE)     {      ModalDialog((ModalPtr) SingleSelectFilterRef,&itemNumber);      switch(itemNumber)        {         case DEFGENERIC_DIALOG_SELECT:           selection = PutSelectionNameInBuffer();           break;         case DEFGENERIC_DIALOG_PRINT:           GenericPrintButton(FindDefgeneric,(char *(*)(VOID *)) GetConstructPPForm,"(ppdefgeneric ",NULL);           break;         case DEFGENERIC_DIALOG_REMOVE:           GenericDeleteButton1(FindDefgeneric,Undefgeneric,&selection,                                &numberOfDefgenerics,(StringPtr) "\p");           break;         case DEFGENERIC_DIALOG_METHODS:           GenericPtr = FindDefgeneric(DialogBuffer);           DoDefmethodManager();           GetDItem(ManagerDialog,DEFGENERIC_DIALOG_SELECT,&itemType,&itemHandle,&dispRect);           dispRect.right -= (SCROLL_BAR_WIDTH - 1);           FrameRect(&dispRect);           LUpdate(ManagerDialog->visRgn,Choices);           OutlineButton(ManagerDialog,DEFGENERIC_DIALOG_DONE,TRUE);           selection = PutSelectionNameInBuffer();           break;         case DEFGENERIC_DIALOG_WATCH:           GenericPtr = FindDefgeneric(DialogBuffer);           if (GenericPtr != NULL)             SetDefgenericWatch(GetDefgenericWatch(GenericPtr) ? OFF : ON,                                GenericPtr);           break;        }      UpdateDefgenericButtons(ManagerDialog,selection);     }   CleanUpAfterManagerDialog(TRUE);  }/************************************************//* UpdateDefgenericButtons: Updates the buttons *//* in the Defgeneric Manager dialog box.        *//************************************************/static void UpdateDefgenericButtons(dptr,selection)  DialogPtr dptr;  int selection;  {#if MAC_MPW || MAC_MCW#pragma unused(selection)#endif   Handle itemHandle;   Rect dispRect;   short int itemType;   void *theDefgeneric;   PutSelectionNameInBuffer();   theDefgeneric = FindDefgeneric(DialogBuffer);   /*=========================================================*/   /* Get information about the remove... button dialog item. */   /*=========================================================*/   GetDItem(dptr,DEFGENERIC_DIALOG_REMOVE,&itemType,&itemHandle,&dispRect);   if ((theDefgeneric == NULL) ? false : IsDefgenericDeletable(theDefgeneric))     { HiliteControl((ControlHandle) itemHandle,ACTIVE_VALUE); }   else     { HiliteControl((ControlHandle) itemHandle,INACTIVE_VALUE); }   /*=========================================================*/   /* Get information about the print... button dialog item. */   /*=========================================================*/   GetDItem(dptr,DEFGENERIC_DIALOG_PRINT,&itemType,&itemHandle,&dispRect);   if ((theDefgeneric == NULL) ? false : (GetDefgenericPPForm(theDefgeneric) != NULL))     { HiliteControl((ControlHandle) itemHandle,ACTIVE_VALUE); }   else     { HiliteControl((ControlHandle) itemHandle,INACTIVE_VALUE); }   /*=========================================================*/   /* Get information about the Methods... button dialog item. */   /*=========================================================*/   GetDItem(dptr,DEFGENERIC_DIALOG_METHODS,&itemType,&itemHandle,&dispRect);   if ((theDefgeneric == NULL) ? false : (GetNextDefmethod(theDefgeneric,0) != 0))     { HiliteControl((ControlHandle) itemHandle,ACTIVE_VALUE); }   else     { HiliteControl((ControlHandle) itemHandle,INACTIVE_VALUE); }        /*=========================================================*/   /* Get information about the trace... button dialog item.  */   /*=========================================================*/   GetDItem(dptr,DEFGENERIC_DIALOG_WATCH,&itemType,&itemHandle,&dispRect);   if (theDefgeneric != NULL)     {      SetCheckBox(dptr,DEFGENERIC_DIALOG_WATCH,GetDefgenericWatch(theDefgeneric));      HiliteControl((ControlHandle) itemHandle,ACTIVE_VALUE);     }   else     {      SetCheckBox(dptr,DEFGENERIC_DIALOG_WATCH,OFF);      HiliteControl((ControlHandle) itemHandle,INACTIVE_VALUE);     }  }/************************************************//* DoDefmethodManager: Handle Methods... button *//*   from Defgeneric Manager dialog.            *//************************************************/static void DoDefmethodManager()  {   char nameBuffer[40];   short int itemNumber = 0;   int selection;   int numberOfMethods;   ListHandle tempChoices;   int tempSelectItem;   DialogPtr tempManagerDialog;   GrafPtr tempDialogManagerSavePort;   void (*tempButtonHandler)(struct GrafPort *,int);   int theMethod;   /*=================================================*/   /* Save the old dialog values since we are placing */   /* a dialog window over a dialog window.           */   /*=================================================*/   tempChoices = Choices;   tempSelectItem = SelectItem;   tempManagerDialog = ManagerDialog;   tempDialogManagerSavePort = DialogManagerSavePort;   tempButtonHandler = UpdateConstructManagerButtonsFunction;   /*===========================================================*/   /* Use the name of the generic function in the dialog title. */   /*===========================================================*/   if (strlen(GetDefgenericName(GenericPtr)) > 35)     {      strncpy(nameBuffer,GetDefgenericName(GenericPtr),35);      strcpy(&nameBuffer[35],"...");     }   else     { strcpy(nameBuffer,GetDefgenericName(GenericPtr)); }   CTOPSTR(nameBuffer);   /*====================*/   /* Create the dialog. */   /*====================*/   DV = 30;   CreateDialogManager(DEFMETHOD_DIALOG_RESOURCE_NUMBER,false);   numberOfMethods = PrepManager(DEFMETHOD_DIALOG_SELECT,                                      GetNextMT,                                      GetMTName1,false,false,(StringPtr) nameBuffer);   DV = 0;   /*================================================================*/   /* Define a ClikLoop function to be called repeatedly as long as  */   /* the mouse button is held down inside the message handler list. */   /* This loop will update the remove... button for the currently   */   /* selected message-handler.                                      */   /*================================================================*/   UpdateConstructManagerButtonsFunction = UpdateMethodButtons;   (*Choices)->lClickLoop = (ClickPtr) DefaultConstructManagerClikloopRef;   /*===========================================================*/   /* Set a global variable indicating which item in the dialog */   /* box is the list. This global value will be used by the    */   /* filter function for the dialog box.                       */   /*===========================================================*/   SelectItem = DEFMETHOD_DIALOG_SELECT;   /*====================================================*/   /* Initialize the last dialog item selected variable. */   /*====================================================*/   itemNumber = DEFMETHOD_DIALOG_SELECT;   selection = GetSingleSelection(Choices);   /*====================================================================*/   /* Outline the Done button to indicate that it is the default button. */   /*====================================================================*/   OutlineButton(ManagerDialog,DEFMETHOD_DIALOG_DONE,TRUE);   /*===============================================*/   /* Update the buttons for the current selection. */   /*===============================================*/   UpdateMethodButtons(ManagerDialog,selection);   /*==================================================================*/   /* Remain in this loop until the user has selected the done button. */   /* The function SingleSelectFilter that is passed as an argument to */   /* ModalDialog is used to handle mouse-clicks in the list.          */   /*==================================================================*/   while (itemNumber != DEFMETHOD_DIALOG_DONE)     {      ModalDialog((ModalPtr) SingleSelectFilterRef,&itemNumber);      switch(itemNumber)        {         case DEFMETHOD_DIALOG_SELECT:           selection = GetSingleSelection(Choices);           break;         case DEFMETHOD_DIALOG_PRINT:#if ! RUN_TIME           theMethod = GetIndexedMethod(selection+1);           FlushCommandString();           PrintCLIPS("stdout","(ppdefmethod ");           PrintCLIPS("stdout",GetDefgenericName(GenericPtr));           PrintCLIPS("stdout"," ");           PrintLongInteger("stdout",(long int) theMethod);           PrintCLIPS("stdout",")\n");           PrintCLIPS("stdout",GetDefmethodPPForm(GenericPtr,theMethod));           PrintPrompt();#endif           break;         case DEFMETHOD_DIALOG_REMOVE:           GenericDeleteButton2(FindMT,DeleteMT,&selection,&numberOfMethods,(StringPtr) nameBuffer);           break;                    case DEFMETHOD_DIALOG_WATCH:           theMethod = GetIndexedMethod(selection+1);           if (theMethod != 0)             SetDefmethodWatch(GetDefmethodWatch(GenericPtr,theMethod) ? OFF : ON,                               GenericPtr,theMethod);           break;        }      UpdateMethodButtons(ManagerDialog,selection);     }   CleanUpAfterManagerDialog(false);   /*================================*/   /* Restore the old dialog values. */   /*================================*/   Choices = tempChoices;   SelectItem = tempSelectItem;   ManagerDialog = tempManagerDialog;   DialogManagerSavePort = tempDialogManagerSavePort;   UpdateConstructManagerButtonsFunction = tempButtonHandler;  }/********************************************//* UpdateMethodButtons: Updates the buttons *//*   in the Method Manager dialog box.      *//********************************************/static void UpdateMethodButtons(dptr,selection)  DialogPtr dptr;  int selection;  {   Handle itemHandle;   Rect dispRect;   short int itemType;   int theMethod;   if (selection == -1) theMethod = 0;   else theMethod = GetIndexedMethod(selection+1);   /*=========================================================*/   /* Get information about the remove... button dialog item. */   /*=========================================================*/   GetDItem(dptr,DEFMETHOD_DIALOG_REMOVE,&itemType,&itemHandle,&dispRect);   if ((theMethod == 0) ? false : IsDefmethodDeletable(GenericPtr,theMethod))     { HiliteControl((ControlHandle) itemHandle,ACTIVE_VALUE); }   else     { HiliteControl((ControlHandle) itemHandle,INACTIVE_VALUE); }   /*=========================================================*/   /* Get information about the print... button dialog item. */   /*=========================================================*/   GetDItem(dptr,DEFMETHOD_DIALOG_PRINT,&itemType,&itemHandle,&dispRect);   if ((theMethod == 0) ? false : (GetDefmethodPPForm(GenericPtr,theMethod) != NULL))     { HiliteControl((ControlHandle) itemHandle,ACTIVE_VALUE); }   else     { HiliteControl((ControlHandle) itemHandle,INACTIVE_VALUE); }        /*=========================================================*/   /* Get information about the trace... button dialog item.  */   /*=========================================================*/   GetDItem(dptr,DEFMETHOD_DIALOG_WATCH,&itemType,&itemHandle,&dispRect);   if (theMethod != 0)     {      SetCheckBox(dptr,DEFMETHOD_DIALOG_WATCH,                  GetDefmethodWatch(GenericPtr,theMethod));      HiliteControl((ControlHandle) itemHandle,ACTIVE_VALUE);     }   else     {      SetCheckBox(dptr,DEFMETHOD_DIALOG_WATCH,OFF);      HiliteControl((ControlHandle) itemHandle,INACTIVE_VALUE);     }  }/****************************************************//* FindMT:                                          *//****************************************************/static void *FindMT(selection)   int selection;   {    int rv;    rv = GetIndexedMethod(selection);    return( (void *) rv);   }/****************************************************//* GetMTPPForm:                                     *//****************************************************/static char *GetMTPPForm(hack)   void *hack;   {    return(GetDefmethodPPForm(GenericPtr,(unsigned int) hack));   }/****************************************************//* DeleteMT:                                     *//****************************************************/static int DeleteMT(hack)   void *hack;   {    return(Undefmethod(GenericPtr,(unsigned int) hack));   }/**********************************************//* GetIndexedMethod: Given N, returns the Nth *//*   method in the handler list.              *//**********************************************/static int GetIndexedMethod(count)  int count;  {   int methodIndex = 0;   int i = 1;   methodIndex = GetNextDefmethod(GenericPtr,0);   while ((methodIndex != 0) && (i < count))     {      methodIndex = GetNextDefmethod(GenericPtr,methodIndex);      i++;     }   return(methodIndex);  }/***************************************************//* GetMTName1:                                     *//***************************************************/static char *GetMTName1(mtPtr)  VOID *mtPtr;  {   int hack;   hack = (int) mtPtr;   GetDefmethodDescription(DialogBuffer,50,GenericPtr,hack);   return(DialogBuffer);  }/***************************************************//* GetMTName2:                                     *//***************************************************/static char *GetMTName2(mtPtr)  VOID *mtPtr;  {   int hack;   hack = (int) mtPtr;   sprintf(DialogBuffer,"%s %d",GetDefgenericName(GenericPtr),hack);   return(DialogBuffer);  }/***************************************************//* GetNextMT:                                      *//***************************************************/static VOID *GetNextMT(mtPtr)  VOID *mtPtr;  {   int hack;   hack = (int) mtPtr;   hack = GetNextDefmethod(GenericPtr,hack);   return((void *) hack);  }#endif