   /*******************************************************/   /*      "C" Language Integrated Production System      */   /*                                                     */   /*            Macintosh Version 3.4  08/10/96          */   /*                                                     */   /*            INTERFACE PREFERENCES MODULE             */   /*******************************************************//*************************************************************//* Purpose: Provides routines for storing and retrieving     *//*   user preference information from the preference file    *//*   associated with this application.                       *//*                                                           *//* Principal Programmer(s):                                  *//*      Gary D. Riley                                        *//*                                                           *//* Contributing Programmer(s):                               *//*                                                           *//* Revision History:                                         *//*                                                           *//*************************************************************/#define _PREFERNC_SOURCE_#include "setup.h"#include <stdio.h>#define _STDIO_INCLUDED_#include <Folders.h>#include <Script.h>#include <TextUtils.h>#if MAC_MPW || MAC_MCW#include <strings.h>#else#include <pascal.h>#endif#if MAC_SC7 || MAC_SC8#define PTOCSTR P2CStr#define CTOPSTR C2PStr#else#define PTOCSTR p2cstr#define CTOPSTR c2pstr#endif#include "agenda.h"#include "bmathfun.h"#include "constant.h"#include "crstrtgy.h"#include "exprnpsr.h"#include "facthsh.h"#include "filecom.h"#include "globlcom.h"#include "incrrset.h"#include "watch.h"#include "apprsrcs.h"#include "editdlog.h"#include "execdlog.h"#include "stnrdmac.h"#include "prefernc.h"#include "interface.h"#define WATCH_PREFERENCES_VERSION        1#define EXECUTION_PREFERENCES_VERSION    1#define ENVIRONMENT_PREFERENCES_VERSION  1#define POSITION_PREFERENCES_VERSION     1#define COMMANDS_PREFERENCES_VERSION     1/***************************************//* LOCAL INTERNAL FUNCTION DEFINITIONS *//***************************************/   static int                     OpenPreferencesFile(FInfo *);   static void                    CreatePreferencesFile(void);   static int                     GetPreferencesFolder(short *,long *);   static Boolean                 GetPreferencesFSSpec(FSSpec *);   static void                    RecallWatchPreferences(void);   static void                    RecallExecutionPreferences(void);   static void                    RecallEnvironmentPreferences(void);   static void                    RecallCommandsPreferences(void);/*******************//* GetPreferences: *//*******************/void GetPreferences()  {   FInfo finderInfo;   OSErr rv;   short theVRefNum, wdRefNum;   long theDirID;   short int apRefNum;   Str255 volName;   Str255 prefFileName;      sprintf((char *) prefFileName,"%s Prefs",APPLICATION_NAME);   CTOPSTR((char *) prefFileName);   if (GetVol(volName,&apRefNum) != noErr) return;      /*===========================================================*/   /* Check for the preferences file in the application folder. */   /*===========================================================*/   rv = GetFInfo(prefFileName,0,&finderInfo);   if (rv == noErr)     {       if (OpenPreferencesFile(&finderInfo))         {         SetVol(NULL,apRefNum);         return;        }      }   /*===========================================================*/   /* Check for the preferences file in the preferences folder. */   /*===========================================================*/   if (GetPreferencesFolder(&theVRefNum,&theDirID))     {      OpenWD(theVRefNum,theDirID,CREATOR_CODE,&wdRefNum);      rv = SetVol(NULL,wdRefNum);      rv = GetFInfo(prefFileName,wdRefNum,&finderInfo);      CloseWD(wdRefNum);      if (rv == noErr)        {          if (OpenPreferencesFile(&finderInfo))            {            SetVol(NULL,apRefNum);            return;           }        }     }   /*======================================================*/   /* Check for the preferences file in the system folder. */   /*======================================================*/   if (GetSystemFolder(&theVRefNum,&theDirID))     {      OpenWD(theVRefNum,theDirID,CREATOR_CODE,&wdRefNum);      rv = SetVol(NULL,wdRefNum);      rv = GetFInfo(prefFileName,wdRefNum,&finderInfo);      CloseWD(wdRefNum);      if (rv == noErr)        {          if (OpenPreferencesFile(&finderInfo))            {            SetVol(NULL,apRefNum);            return;           }         }     }        /*=============================*/   /* Create the preferences file */   /* if it does not exist.       */   /*=============================*/      CreatePreferencesFile();   SetVol(NULL,apRefNum);  }/***************************************************************//* OpenPreferencesFile: Attempts to open the preferences file. *//***************************************************************/static int OpenPreferencesFile(finderInfo)  FInfo *finderInfo;  {   FILE *tempFP;   char prefFileName[40];      sprintf(prefFileName,"%s Prefs",APPLICATION_NAME);   if (((finderInfo->fdCreator == CREATOR_CODE) && (finderInfo->fdType == 'BTCH')) ||       ((finderInfo->fdCreator == 'CLPS') && (finderInfo->fdType == 'BTCH')) ||        (finderInfo->fdType == 'TEXT'))     {      tempFP = fopen(prefFileName,"r");      if (tempFP != NULL)             {         fclose(tempFP);         OpenBatch(prefFileName,true);        }            RecallWatchPreferences();          RecallExecutionPreferences();         RecallEnvironmentPreferences();        RecallCommandsPreferences();          return(true);     }        return(false);  }/***********************************************//* CreatePreferencesFile: Creates a preference *//*   file in the systems preferences folder.   *//***********************************************/static void CreatePreferencesFile()  {   long theDirID;   short theVRefNum, wdRefNum;   Str255 prefFileName;   OSErr theError;      if (! GetPreferencesFolder(&theVRefNum,&theDirID))     { return; }        sprintf((char *) prefFileName,"%s Prefs",APPLICATION_NAME);   CTOPSTR((char *) prefFileName);      if (OpenWD(theVRefNum,theDirID,CREATOR_CODE,&wdRefNum))     { return; }      if (SetVol(NULL,wdRefNum))     {      CloseWD(wdRefNum);      return;      }      theError = Create(prefFileName,wdRefNum,CREATOR_CODE,'TEXT');      CloseWD(wdRefNum);  }/*********************************************************************//* GetPreferencesFolder: Returns the volume reference number and the *//*   directory ID of the Preferences folder (under system 7.0). Both *//*   values are returned in the calling arguments provided and the   *//*   value TRUE is returned if the folder was found, otherwise false *//*   is returned.                                                    *//*********************************************************************/static int GetPreferencesFolder(  short *theVRefNum,  long *theDirID)  {   if (FindFolder(kOnSystemDisk,kPreferencesFolderType,kDontCreateFolder,                  theVRefNum,theDirID) == noErr)     { return(true); }   else if (FindFolder(kOnSystemDisk,kSystemFolderType,kDontCreateFolder,                       theVRefNum,theDirID) == noErr)     { return(true); }   return(false);  }/***********************************************************//* GetPreferencesFSSpec: Searches for the preferences file *//*   in the application's folder, the system folder, and   *//*   the preferences folder. If the preferences file is    *//*   found, FSSpec information is copied to the supplied   *//*   FSSpec structure.                                     *//***********************************************************/static Boolean GetPreferencesFSSpec(  FSSpec *theSpec)  {   Str255 prefFileName;     short theVRefNum;   long theDirID;      sprintf((char *) prefFileName,"%s Prefs",APPLICATION_NAME);   CTOPSTR((char *) prefFileName);      if (! FSMakeFSSpec(ApplicationVRefNum,ApplicationDirID,prefFileName,theSpec))     { return(true); }       if (GetPreferencesFolder(&theVRefNum,&theDirID))     {      if (! FSMakeFSSpec(theVRefNum,theDirID,prefFileName,theSpec))        { return(true); }     }        if (GetSystemFolder(&theVRefNum,&theDirID))     {      if (! FSMakeFSSpec(theVRefNum,theDirID,prefFileName,theSpec))        { return(true); }     }        return(false);  }/**********************************************//* RememberPreferences: Updates a preferences *//*   resource in the preference file.         *//**********************************************/void RememberPreferences(  ResType resType,  short resID,  Handle theResource)  {   short fileReference;   OSErr resourceError;   Handle tempHandle;   FSSpec *theFSSpec, storage;      /*============================*/   /* Find the preferences file. */   /*============================*/      theFSSpec = &storage;   if (! GetPreferencesFSSpec(theFSSpec))     {      DisposeHandle(theResource);      return;     }      /*============================================*/   /* Try opening the resource fork of the file. */   /*============================================*/     fileReference = FSpOpenResFile(theFSSpec,fsRdWrPerm);   resourceError = ResError();      /*==========================================*/   /* If the resource fork couldn't be opened, */   /* try to correct the problem.              */   /*==========================================*/      if ((fileReference == -1) || (resourceError != noErr))     {       /*====================================*/      /* If no resource fork exists, try    */      /* creating it and then reopening it. */      /*====================================*/            if ((resourceError == mapReadErr) ||           (resourceError == eofErr))        {         FSpCreateResFile(theFSSpec,CREATOR_CODE,'TEXT',smSystemScript);         resourceError = ResError();         if (resourceError != noErr)            {            DisposeHandle(theResource);            return;           }			         fileReference = FSpOpenResFile(theFSSpec,fsRdWrPerm);         resourceError = ResError();         if ((fileReference == -1) || (resourceError != noErr))           {             DisposeHandle(theResource);            return;            }        }               /*==================*/      /* Otherwise, punt. */      /*==================*/            else         {          DisposeHandle(theResource);         return;         }     }        /*=============================================*/   /* Otherwise, there was no problem opening the */   /* resource fork. This means it could already  */   /* contain the resource. Check to see if the   */   /* resource exists, and if so, remove it.      */   /*=============================================*/        else     {      UseResFile(fileReference);      tempHandle = Get1Resource(resType,resID);      resourceError = ResError();         if ((tempHandle != NULL) && (resourceError == noErr))         {         RmveResource(tempHandle);         UpdateResFile(fileReference);        }     }   /*==========================================*/   /* Make sure we are using the correct file. */   /*==========================================*/      UseResFile(fileReference);      /*===============================*/   /* Add the resource to the file. */   /*===============================*/      AddResource(theResource,resType,resID,"\p");      resourceError = ResError();   if (resourceError != noErr)     {      DisposeHandle(theResource);      CloseResFile(fileReference);      return;     }   /*===========================*/   /* Update the resource file. */   /*===========================*/   	   UpdateResFile(fileReference);	   /*===============================*/   /* Deallocate the MPSR resource. */   /*===============================*/      DetachResource(theResource);   DisposeHandle(theResource);      /*==========================*/   /* Close the resource file. */   /*==========================*/        CloseResFile(fileReference);  }/*********************************************//* GetPreferenceResource: Extracts and makes *//*   a copy of the specified resource from   *//*   the preferences file.                   *//*********************************************/Handle GetPreferenceResource(  ResType resType,  short resID)  {   short fileReference;   OSErr resourceError;   Handle tempHandle, theResource = NULL;   FSSpec *theFSSpec, storage;      /*============================*/   /* Find the preferences file. */   /*============================*/      theFSSpec = &storage;   if (! GetPreferencesFSSpec(theFSSpec))     { return(NULL); }      /*====================================*/   /* Look for the resource in the file. */   /*====================================*/     fileReference = FSpOpenResFile(theFSSpec,fsRdWrPerm);   resourceError = ResError();   if ((fileReference != -1) && (resourceError == noErr))     {      UseResFile(fileReference);            tempHandle = Get1Resource(resType,resID);      resourceError = ResError();      if ((tempHandle != NULL) && (resourceError == noErr))         {         theResource = tempHandle;         resourceError = HandToHand(&theResource);         if (resourceError != noErr)           { theResource = NULL; }         DisposeHandle(tempHandle);        }              CloseResFile(fileReference);     }     return(theResource);  }         /************************************************//* CreateWatchResource: Creates a WTCH resource *//*   containing watch item preferences.         *//************************************************/WatchRSRCHdl CreateWatchResource(   Boolean compilations,   Boolean facts,   Boolean rules,   Boolean statistics,   Boolean activations,   Boolean focus,   Boolean globals,   Boolean deffunctions,   Boolean generic_functions,   Boolean methods,   Boolean instances,   Boolean slots,   Boolean message_handlers,   Boolean messages)  {   WatchRSRCHdl theResource;      theResource = (WatchRSRCHdl) NewHandle(sizeof(WatchRSRC));      (*theResource)->version = WATCH_PREFERENCES_VERSION;   (*theResource)->compilations = compilations;   (*theResource)->facts = facts;   (*theResource)->rules = rules;   (*theResource)->statistics = statistics;   (*theResource)->activations = activations;   (*theResource)->focus = focus;   (*theResource)->globals = globals;   (*theResource)->deffunctions = deffunctions;   (*theResource)->generic_functions = generic_functions;   (*theResource)->methods = methods;   (*theResource)->instances = instances;   (*theResource)->slots = slots;   (*theResource)->message_handlers = message_handlers;   (*theResource)->messages = messages;   return(theResource);  }      /**********************************************//* RecallWatchPreferences: Restores the watch *//*   preferences based on the values stored   *//*   in the preferences file.                 *//**********************************************/static void RecallWatchPreferences()  {   WatchRSRCHdl watchPrefs;      watchPrefs = (WatchRSRCHdl) GetPreferenceResource(watchResType,watchResID);   if (watchPrefs == NULL) return;      SetWatchItem("compilations",(*watchPrefs)->compilations,NULL);   SetWatchItem("facts",(*watchPrefs)->facts,NULL);   SetWatchItem("rules",(*watchPrefs)->rules,NULL);   SetWatchItem("statistics",(*watchPrefs)->statistics,NULL);   SetWatchItem("activations",(*watchPrefs)->activations,NULL);   SetWatchItem("focus",(*watchPrefs)->focus,NULL);   SetWatchItem("globals",(*watchPrefs)->globals,NULL);   SetWatchItem("deffunctions",(*watchPrefs)->deffunctions,NULL);   SetWatchItem("generic-functions",(*watchPrefs)->generic_functions,NULL);   SetWatchItem("methods",(*watchPrefs)->methods,NULL);   SetWatchItem("instances",(*watchPrefs)->instances,NULL);   SetWatchItem("slots",(*watchPrefs)->slots,NULL);   SetWatchItem("message-handlers",(*watchPrefs)->message_handlers,NULL);   SetWatchItem("messages",(*watchPrefs)->messages,NULL);  }/*****************************************************//* CreateExecutionResource: Creates an EXEC resource *//*   containing execution option preferences.        *//*****************************************************/ExecutionRSRCHdl CreateExecutionResource(  char salience_evaluation,  char strategy,  Boolean static_constraint_checking,  Boolean dynamic_constraint_checking,  Boolean reset_global_variables,  Boolean sequence_expansion_operator_recognition,  Boolean incremental_reset,  Boolean auto_float_dividend,  Boolean fact_duplication)  {   ExecutionRSRCHdl theResource;      theResource = (ExecutionRSRCHdl) NewHandle(sizeof(ExecutionRSRC));      (*theResource)->version = EXECUTION_PREFERENCES_VERSION;   (*theResource)->salience_evaluation = salience_evaluation;   (*theResource)->strategy = strategy;   (*theResource)->static_constraint_checking = static_constraint_checking;   (*theResource)->dynamic_constraint_checking = dynamic_constraint_checking;   (*theResource)->reset_global_variables = reset_global_variables;   (*theResource)->sequence_expansion_operator_recognition =      sequence_expansion_operator_recognition;   (*theResource)->incremental_reset = incremental_reset;   (*theResource)->auto_float_dividend = auto_float_dividend;   (*theResource)->fact_duplication = fact_duplication;   return(theResource);  }/******************************************************//* RecallExecutionPreferences: Restores the execution *//*   options preferences based on the values stored   *//*   in the preferences file.                         *//******************************************************/static void RecallExecutionPreferences()  {   ExecutionRSRCHdl executionPrefs;      executionPrefs = (ExecutionRSRCHdl)                    GetPreferenceResource(executionResType,executionResID);   if (executionPrefs == NULL) return;      SetSalienceEvaluation((*executionPrefs)->salience_evaluation);   SetStrategy((*executionPrefs)->strategy);   SetStaticConstraintChecking((*executionPrefs)->static_constraint_checking);   SetDynamicConstraintChecking((*executionPrefs)->dynamic_constraint_checking);   SetResetGlobals((*executionPrefs)->reset_global_variables);   SetSequenceOperatorRecognition((*executionPrefs)->sequence_expansion_operator_recognition);   SetIncrementalReset((*executionPrefs)->incremental_reset);   SetAutoFloatDividend((*executionPrefs)->auto_float_dividend);   SetFactDuplication((*executionPrefs)->fact_duplication);  }/*******************************************************//* CreateEnvironmentResource: Creates an ENVR resource *//*   containing environment option preferences.        *//*******************************************************/EnvironmentRSRCHdl CreateEnvironmentResource(  Boolean warnings,  Boolean command_completion,  Boolean remember_edit_window_state,  Boolean remember_environment_window_state,  Boolean honor_edit_window_state,  Boolean honor_environment_window_state)  {   EnvironmentRSRCHdl theResource;      theResource = (EnvironmentRSRCHdl) NewHandle(sizeof(EnvironmentRSRC));      (*theResource)->version = ENVIRONMENT_PREFERENCES_VERSION;   (*theResource)->warnings = warnings;   (*theResource)->command_completion = command_completion;   (*theResource)->remember_edit_window_state = remember_edit_window_state;   (*theResource)->remember_environment_window_state = remember_environment_window_state;   (*theResource)->honor_edit_window_state = honor_edit_window_state;   (*theResource)->honor_environment_window_state = honor_environment_window_state;   return(theResource);  }/************************************************//* RecallEnvironmentPreferences: Restores the   *//*   environment options preferences based on   *//*   the values stored in the preferences file. *//************************************************/static void RecallEnvironmentPreferences()  {   EnvironmentRSRCHdl environmentPrefs;      environmentPrefs = (EnvironmentRSRCHdl)                      GetPreferenceResource(environmentResType,environmentResID);   if (environmentPrefs == NULL) return;      WarningsOption = (*environmentPrefs)->warnings;   CommandCompletionDialog = (*environmentPrefs)->command_completion;   RememberEditWindowState = (*environmentPrefs)->remember_edit_window_state;   RememberEnvironmentWindowState = (*environmentPrefs)->remember_environment_window_state;   HonorEditWindowState = (*environmentPrefs)->honor_edit_window_state;   HonorEnvironmentWindowState = (*environmentPrefs)->honor_environment_window_state;  }/********************************************//* CreatePositionResource: Creates a PSTN   *//*   resource containing environment window *//*   position preferences.                  *//********************************************/PositionRSRCHdl CreatePositionResource(  short top,  short left,  short height,  short width)  {   PositionRSRCHdl theResource;      theResource = (PositionRSRCHdl) NewHandle(sizeof(PositionRSRC));      (*theResource)->version = POSITION_PREFERENCES_VERSION;   (*theResource)->top = top;   (*theResource)->left = left;   (*theResource)->height = height;   (*theResource)->width = width;   return(theResource);  }/***************************************************//* RecallPositionPreferences: Restores environment *//*   window position preferences based on values   *//*   stored in the preferences file.               *//***************************************************/Boolean RecallPositionPreferences(  short resID,  short *top,  short *left,  short *height,  short *width)  {   PositionRSRCHdl positionPrefs;      positionPrefs = (PositionRSRCHdl)                      GetPreferenceResource(positionResType,resID);   if (positionPrefs == NULL) return(false);      *top = (*positionPrefs)->top;   *left = (*positionPrefs)->left;   *height = (*positionPrefs)->height;   *width = (*positionPrefs)->width;      return(true);  }    /***************************************************//* CreateCommandsResource: Creates a CMND resource *//*   containing Set Commands... item preferences.  *//***************************************************/CommandsRSRCHdl CreateCommandsResource(  DialogPtr theDialog)  {   CommandsRSRCHdl theResource;   short int itemType;   Handle itemHandle;   Rect dispRect;      theResource = (CommandsRSRCHdl) NewHandle(sizeof(CommandsRSRC));      (*theResource)->version = COMMANDS_PREFERENCES_VERSION;      GetDItem(theDialog,SET_COMMANDS_DIALOG_COMMAND1,&itemType,&itemHandle,&dispRect);   GetIText(itemHandle,(*theResource)->command1);      GetDItem(theDialog,SET_COMMANDS_DIALOG_COMMAND2,&itemType,&itemHandle,&dispRect);   GetIText(itemHandle,(*theResource)->command2);      GetDItem(theDialog,SET_COMMANDS_DIALOG_COMMAND3,&itemType,&itemHandle,&dispRect);   GetIText(itemHandle,(*theResource)->command3);      GetDItem(theDialog,SET_COMMANDS_DIALOG_COMMAND4,&itemType,&itemHandle,&dispRect);   GetIText(itemHandle,(*theResource)->command4);      GetDItem(theDialog,SET_COMMANDS_DIALOG_COMMAND5,&itemType,&itemHandle,&dispRect);   GetIText(itemHandle,(*theResource)->command5);      GetDItem(theDialog,SET_COMMANDS_DIALOG_COMMAND6,&itemType,&itemHandle,&dispRect);   GetIText(itemHandle,(*theResource)->command6);      GetDItem(theDialog,SET_COMMANDS_DIALOG_COMMAND7,&itemType,&itemHandle,&dispRect);   GetIText(itemHandle,(*theResource)->command7);      GetDItem(theDialog,SET_COMMANDS_DIALOG_COMMAND8,&itemType,&itemHandle,&dispRect);   GetIText(itemHandle,(*theResource)->command8);      GetDItem(theDialog,SET_COMMANDS_DIALOG_COMMAND9,&itemType,&itemHandle,&dispRect);   GetIText(itemHandle,(*theResource)->command9);      GetDItem(theDialog,SET_COMMANDS_DIALOG_COMMAND0,&itemType,&itemHandle,&dispRect);   GetIText(itemHandle,(*theResource)->command0);     return(theResource);  }/***********************************************//* RecallCommandsPreferences: Restores the Set *//*   Commands...  preferences based on the     *//*   values stored in the preferences file.    *//***********************************************/static void RecallCommandsPreferences()  {   CommandsRSRCHdl commandsPrefs;      commandsPrefs = (CommandsRSRCHdl)                      GetPreferenceResource(commandsResType,commandsResID);   if (commandsPrefs == NULL) return;      SetItem(CommandsMenu,Command1Item,(*commandsPrefs)->command1);    SetItem(CommandsMenu,Command2Item,(*commandsPrefs)->command2);     SetItem(CommandsMenu,Command3Item,(*commandsPrefs)->command3);     SetItem(CommandsMenu,Command4Item,(*commandsPrefs)->command4);     SetItem(CommandsMenu,Command5Item,(*commandsPrefs)->command5);     SetItem(CommandsMenu,Command6Item,(*commandsPrefs)->command6);     SetItem(CommandsMenu,Command7Item,(*commandsPrefs)->command7);     SetItem(CommandsMenu,Command8Item,(*commandsPrefs)->command8);     SetItem(CommandsMenu,Command9Item,(*commandsPrefs)->command9);     SetItem(CommandsMenu,Command0Item,(*commandsPrefs)->command0);   }  