   /*******************************************************/   /*      "C" Language Integrated Production System      */   /*                                                     */   /*             Macintosh Version 3.3  04/02/96         */   /*                                                     */   /*        RULE AND AGENDA DIALOG MANAGER MODULE        */   /*******************************************************//*************************************************************//* Purpose:                                                  *//*                                                           *//* Principal Programmer(s):                                  *//*      Gary D. Riley                                        *//*                                                           *//* Contributing Programmer(s):                               *//*                                                           *//* Revision History:                                         *//*                                                           *//*************************************************************/#define _RULEDLOG_SOURCE_#include "setup.h"#if DEFRULE_CONSTRUCT#include <Dialogs.h>#if MAC_SC7 || MAC_MCW || MAC_SC8#define ClickPtr ListClickLoopUPP#else#define ClickPtr ProcPtr#endif#if MAC_MCW || MAC_SC8#define ModalPtr ModalFilterUPP#else#define ModalPtr ModalFilterProcPtr#endif#include "router.h"#include "commline.h"#include "rulecom.h"#include "ruledef.h"#include "rulebsc.h"#include "agenda.h"#include "engine.h"#include "dlogmngr.h"#include "window.h"#include "statusw.h"#include "kbstatw.h"#include "stnrdmac.h"#include "ruledlog.h"/***************************************//* LOCAL INTERNAL FUNCTION DEFINITIONS *//***************************************/   static void                   UpdateDefruleButtons(DialogPtr,int);   static void                   UpdateAgendaButtons(DialogPtr,int);   static VOID                  *GetIndexedActivation(int);   static char                  *GetActivationString(VOID *);/**************************************************//* DoRuleManager: Handle Rule Manager... command. *//**************************************************/void DoDefruleManager()  {   short int itemNumber = 0;   int selection;   int numberOfRules;   void *theRule;   CreateDialogManager(DEFRULE_DIALOG_RESOURCE_NUMBER,TRUE);   numberOfRules = PrepManager(DEFRULE_DIALOG_SELECT,GetNextDefrule,(char *(*)(VOID *)) GetConstructNameString,                               TRUE,false,(StringPtr) "\p");   /*===============================================================*/   /* Define a ClikLoop function to be called repeatedly as long as */   /* the mouse button is held down inside the rule list. This loop */   /* will update the break button for the currently selected rule. */   /*===============================================================*/   UpdateConstructManagerButtonsFunction = UpdateDefruleButtons;   (*Choices)->lClickLoop = (ClickPtr) DefaultConstructManagerClikloopRef;   /*===========================================================*/   /* Set a global variable indicating which item in the dialog */   /* box is the list. This global value will be used by the    */   /* Click Loop routine for the dialog box.                    */   /*===========================================================*/   SelectItem = DEFRULE_DIALOG_SELECT;   /*===================================================*/   /* Initialize the last dialog item selected variable */   /* and the current rule selection variable.          */   /*===================================================*/   itemNumber = DEFRULE_DIALOG_SELECT;   selection = PutSelectionNameInBuffer();   /*====================================================================*/   /* Outline the Done button to indicate that it is the default button. */   /*====================================================================*/   OutlineButton(ManagerDialog,DEFRULE_DIALOG_DONE,TRUE);   /*===============================================*/   /* Update the buttons for the current selection. */   /*===============================================*/   UpdateDefruleButtons(ManagerDialog,selection);   /*==================================================================*/   /* Remain in this loop until the user has selected the done button. */   /* The function SingleSelectFilter that is passed as an argument to */   /* ModalDialog is used to handle mouse-clicks in the list.          */   /*==================================================================*/   while (itemNumber != DEFRULE_DIALOG_DONE)     {      ModalDialog((ModalPtr) SingleSelectFilterRef,&itemNumber);      switch(itemNumber)        {         case DEFRULE_DIALOG_SELECT:           selection = PutSelectionNameInBuffer();           break;         case DEFRULE_DIALOG_MATCHES:#if DEBUGGING_FUNCTIONS           theRule = FindDefrule(DialogBuffer);           if (theRule != NULL)             {#if ! RUN_TIME              FlushCommandString();              PrintCLIPS("stdout","(matches ");              PrintCLIPS("stdout",DialogBuffer);              PrintCLIPS("stdout",")\n");              Matches(theRule);              PrintPrompt();#else              PrintCLIPS("stdout","Matches for ");              PrintCLIPS("stdout",DialogBuffer);              PrintCLIPS("stdout","...\n");              Matches(theRule);#endif             }#endif           break;         case DEFRULE_DIALOG_PRINT:           GenericPrintButton(FindDefrule,(char *(*)(VOID *)) GetConstructPPForm,"(ppdefrule ",NULL);           break;         case DEFRULE_DIALOG_REMOVE:           GenericDeleteButton1(FindDefrule,Undefrule,&selection,&numberOfRules,(StringPtr) "\p");           break;         case DEFRULE_DIALOG_REFRESH:           theRule = FindDefrule(DialogBuffer);           if (theRule != NULL) Refresh(theRule);           if (AgendaWindow != NULL)             {              CompleteStatusRefresh(AgendaWindow);              StatusUpdateRoutine(AgendaWindow);             }           break;         case DEFRULE_DIALOG_BREAK:#if DEBUGGING_FUNCTIONS           theRule = FindDefrule(DialogBuffer);           if (theRule != NULL)             {              if (DefruleHasBreakpoint(theRule))               { RemoveBreak(theRule); }              else               { SetBreak(theRule); }             }#endif           break;         case DEFRULE_DIALOG_ACTIVATION:#if DEBUGGING_FUNCTIONS           theRule = FindDefrule(DialogBuffer);           if (theRule != NULL)             SetDefruleWatchActivations(GetDefruleWatchActivations(theRule) ? OFF : ON,                                       theRule);#endif           break;                    case DEFRULE_DIALOG_FIRING:#if DEBUGGING_FUNCTIONS           theRule = FindDefrule(DialogBuffer);           if (theRule != NULL)             SetDefruleWatchFirings(GetDefruleWatchFirings(theRule) ? OFF : ON,theRule);#endif           break;                    default:           break;        }      UpdateDefruleButtons(ManagerDialog,selection);     }   /*====================*/   /* Remove the dialog. */   /*====================*/   CleanUpAfterManagerDialog(TRUE);  }/*********************************************//* UpdateDefruleButtons: Updates the buttons *//* in the Defrule Manager dialog box.        *//*********************************************/static void UpdateDefruleButtons(dptr,selection)  DialogPtr dptr;  int selection;  {#if MAC_MPW || MAC_MCW#pragma unused(selection)#endif   Handle itemHandle;   Rect dispRect;   short int itemType;   VOID *theRule;   /*===================================*/   /* Determine which rule is selected. */   /*===================================*/   PutSelectionNameInBuffer();   theRule = FindDefrule(DialogBuffer);   /*=====================================*/   /* Update refresh and matches buttons. */   /*=====================================*/   if (theRule == NULL)     {      GetDItem(dptr,DEFRULE_DIALOG_REFRESH,&itemType,&itemHandle,&dispRect);      HiliteControl((ControlHandle) itemHandle,INACTIVE_VALUE);      GetDItem(dptr,DEFRULE_DIALOG_MATCHES,&itemType,&itemHandle,&dispRect);      HiliteControl((ControlHandle) itemHandle,INACTIVE_VALUE);     }   else     {      GetDItem(dptr,DEFRULE_DIALOG_REFRESH,&itemType,&itemHandle,&dispRect);      HiliteControl((ControlHandle) itemHandle,ACTIVE_VALUE);      GetDItem(dptr,DEFRULE_DIALOG_MATCHES,&itemType,&itemHandle,&dispRect);      HiliteControl((ControlHandle) itemHandle,ACTIVE_VALUE);     }   /*==========================*/   /* Update debug checkboxes. */   /*==========================*/      GetDItem(dptr,DEFRULE_DIALOG_BREAK,&itemType,&itemHandle,&dispRect);#if DEBUGGING_FUNCTIONS   if (theRule != NULL)     {      SetCheckBox(dptr,DEFRULE_DIALOG_BREAK,DefruleHasBreakpoint(theRule));      HiliteControl((ControlHandle) itemHandle,ACTIVE_VALUE);     }   else#endif     {      SetCheckBox(dptr,DEFRULE_DIALOG_BREAK,OFF);      HiliteControl((ControlHandle) itemHandle,INACTIVE_VALUE);     }        GetDItem(dptr,DEFRULE_DIALOG_ACTIVATION,&itemType,&itemHandle,&dispRect);   #if DEBUGGING_FUNCTIONS   if (theRule != NULL)     {      SetCheckBox(dptr,DEFRULE_DIALOG_ACTIVATION,GetDefruleWatchActivations(theRule));      HiliteControl((ControlHandle) itemHandle,ACTIVE_VALUE);     }   else#endif     {      SetCheckBox(dptr,DEFRULE_DIALOG_ACTIVATION,OFF);      HiliteControl((ControlHandle) itemHandle,INACTIVE_VALUE);     }        GetDItem(dptr,DEFRULE_DIALOG_FIRING,&itemType,&itemHandle,&dispRect);#if DEBUGGING_FUNCTIONS   if (theRule != NULL)     {      SetCheckBox(dptr,DEFRULE_DIALOG_FIRING,GetDefruleWatchFirings(theRule));      HiliteControl((ControlHandle) itemHandle,ACTIVE_VALUE);     }   else#endif     {      SetCheckBox(dptr,DEFRULE_DIALOG_FIRING,OFF);      HiliteControl((ControlHandle) itemHandle,INACTIVE_VALUE);     }        /*=======================*/   /* Update Remove button. */   /*=======================*/   GetDItem(dptr,DEFRULE_DIALOG_REMOVE,&itemType,&itemHandle,&dispRect);   if ((theRule == NULL) ? false : IsDefruleDeletable(theRule))     { HiliteControl((ControlHandle) itemHandle,ACTIVE_VALUE); }   else     { HiliteControl((ControlHandle) itemHandle,INACTIVE_VALUE); }   /*======================*/   /* Update Print button. */   /*======================*/   GetDItem(dptr,DEFRULE_DIALOG_PRINT,&itemType,&itemHandle,&dispRect);   if ((theRule == NULL) ? false : (GetConstructPPForm(theRule) != NULL))     { HiliteControl((ControlHandle) itemHandle,ACTIVE_VALUE); }   else     { HiliteControl((ControlHandle) itemHandle,INACTIVE_VALUE); }  }/******************************************************//* DoAgendaManager: Handle Agenda Manager... command. *//******************************************************/void DoAgendaManager()  {   short int itemNumber = 0;   int selection;   int numberOfActivations;   CreateDialogManager(AGENDA_DIALOG_RESOURCE_NUMBER,TRUE);   numberOfActivations = PrepManager(AGENDA_DIALOG_SELECT,                                     GetNextActivation,                                     GetActivationString,false,false,(StringPtr) "\p");   /*===============================================================*/   /* Define a ClikLoop function to be called repeatedly as long as */   /* the mouse button is held down inside the list of items. This  */   /* loop will update buttons applicable to the currently selected */   /* item.                                                         */   /*===============================================================*/   UpdateConstructManagerButtonsFunction = UpdateAgendaButtons;   (*Choices)->lClickLoop = (ClickPtr) DefaultConstructManagerClikloopRef;   /*===========================================================*/   /* Set a global variable indicating which item in the dialog */   /* box is the list. This global value will be used by the    */   /* filter function for the dialog box.                       */   /*===========================================================*/   SelectItem = AGENDA_DIALOG_SELECT;   /*====================================================*/   /* Initialize the last dialog item selected variable. */   /*====================================================*/   itemNumber = AGENDA_DIALOG_SELECT;   selection = GetSingleSelection(Choices);   /*====================================================================*/   /* Outline the Done button to indicate that it is the default button. */   /*====================================================================*/   OutlineButton(ManagerDialog,AGENDA_DIALOG_DONE,TRUE);   /*==================================================================*/   /* Remain in this loop until the user has selected the done button. */   /* The function SingleSelectFilter that is passed as an argument to */   /* ModalDialog is used to handle mouse-clicks in the list.          */   /*==================================================================*/   while (itemNumber != AGENDA_DIALOG_DONE)     {      ModalDialog((ModalPtr) SingleSelectFilterRef,&itemNumber);      switch(itemNumber)        {         case AGENDA_DIALOG_SELECT:           selection = GetSingleSelection(Choices);           break;         case AGENDA_DIALOG_FIRE:           MoveActivationToTop(GetIndexedActivation(selection + 1));           if (AgendaWindow != NULL)             {              CompleteStatusRefresh(AgendaWindow);              StatusUpdateRoutine(AgendaWindow);             }           SetAgendaChanged(false);#if ! RUN_TIME           FlushCommandString();           SetCommandString("(run 1)\n");           PrintCLIPS("stdout","(run 1)\n");           itemNumber = AGENDA_DIALOG_DONE;           FlashButton((DialogPtr) ManagerDialog,AGENDA_DIALOG_DONE);#else           FlashButton((DialogPtr) ManagerDialog,AGENDA_DIALOG_DONE);           CleanUpAfterManagerDialog(TRUE);           Run(1);           return;#endif           break;         case AGENDA_DIALOG_REMOVE:           GenericDeleteButton2(GetIndexedActivation,DeleteActivation,&selection,                                &numberOfActivations,(StringPtr) "\p");           break;        }      UpdateAgendaButtons(ManagerDialog,selection);     }   /*======================*/   /* Perform the command. */   /*======================*/   CleanUpAfterManagerDialog(TRUE);  }/********************************************//* UpdateAgendaButtons: Updates the buttons *//* in the Agenda Manager dialog box.        *//********************************************/static void UpdateAgendaButtons(dptr,selection)  DialogPtr dptr;  int selection;  {   Handle itemHandle;   Rect dispRect;   short int itemType;   /*=========================================================*/   /* Get information about the remove... button dialog item. */   /*=========================================================*/   GetDItem(dptr,AGENDA_DIALOG_REMOVE,&itemType,&itemHandle,&dispRect);   if (selection >= 0)     { HiliteControl((ControlHandle) itemHandle,ACTIVE_VALUE); }   else     { HiliteControl((ControlHandle) itemHandle,INACTIVE_VALUE); }   /*=========================================================*/   /* Get information about the print... button dialog item. */   /*=========================================================*/   GetDItem(dptr,AGENDA_DIALOG_FIRE,&itemType,&itemHandle,&dispRect);   if (selection >= 0)     { HiliteControl((ControlHandle) itemHandle,ACTIVE_VALUE); }   else     { HiliteControl((ControlHandle) itemHandle,INACTIVE_VALUE); }  }/**************************************************//* GetIndexedActivation: Given N, returns the Nth *//*  activation on the agenda.                     *//**************************************************/static VOID *GetIndexedActivation(count)  int count;  {   VOID *activationPtr = NULL;   int i = 1;   activationPtr = GetNextActivation(NULL);   while ((activationPtr != NULL) && (i < count))     {      activationPtr = GetNextActivation(activationPtr);      i++;     }   return(activationPtr);  }/***************************************************//* GetActivationString:                         *//***************************************************/static char *GetActivationString(act_ptr)  VOID *act_ptr;  {   GetActivationPPForm(DialogBuffer,DIALOG_BUFFER_SIZE,act_ptr);   return(DialogBuffer);  }#endif