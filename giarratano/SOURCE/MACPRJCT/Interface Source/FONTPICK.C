   /*******************************************************/   /*      "C" Language Integrated Production System      */   /*                                                     */   /*            Macintosh Version 3.2  05/12/93          */   /*                                                     */   /*                 FONT PICKER MODULE                  */   /*******************************************************//*************************************************************//* Purpose:                                                  *//*                                                           *//* Principal Programmer(s):                                  *//*      Gary D. Riley                                        *//*                                                           *//* Contributing Programmer(s):                               *//*                                                           *//* Revision History:                                         *//*                                                           *//*************************************************************/#define _FONTPICK_SOURCE_#include "setup.h"#include <string.h>#include <stdlib.h>#if THINK_C#include <BDC.h>#endif#include <Packages.h>#include <Fonts.h>#include <Dialogs.h>#include <Events.h>#include <Lists.h>#include <ToolUtils.h>#if THINK_C /* Defined by the Think C Environment */#include <pascal.h>#else#include <strings.h>#endif#if MAC_MCW || MAC_SC8#define ModalPtr ModalFilterUPP#else#define ModalPtr ModalFilterProcPtr#endif#include "fontpick.h"#include "stnrdmac.h"#include "window.h"#include "menuhndl.h"#define FONT_MENU_ID 300#define SIZE_MENU_ID 301/***************************************//* LOCAL INTERNAL FUNCTION DEFINITIONS *//***************************************/   static void                   CreateFontDialog(void);   static int                    PerformFontDialog(short int *,short int *);   static int                    FindFontInMenu(int,MenuHandle);   static void                   DrawTextInRect(int,int,char *,Rect *);   static MenuHandle             CreateSizeMenu(short int,short int *,short int *);/***************************************//* LOCAL INTERNAL VARIABLE DEFINITIONS *//***************************************/   static ListHandle       FontChoices;   static DialogPtr        FontDialog;/******************************************//* DoSetFont: Handle Set Font... command. *//******************************************/int DoSetFont(newFontPtr,newSizePtr)  short int *newFontPtr, *newSizePtr;  {   GrafPtr savePort;   int doChange;   /*====================*/   /* Save the old port. */   /*====================*/   GetPort(&savePort);   /*=========================*/   /* Create the font dialog. */   /*=========================*/   CreateFontDialog();   /*==========================*/   /* Perform the font dialog. */   /*==========================*/   doChange = PerformFontDialog(newFontPtr,newSizePtr);   /*===================================================*/   /* Dispose of the font dialog. */   /*===================================================*/   DisposDialog(FontDialog);   /*=======================*/   /* Restore the old port. */   /*=======================*/   SetPort(savePort);   /*====================================*/   /* Return flag indicating whether the */   /* font change should be performed.   */   /*====================================*/   return(doChange);  }/******************************************************************//* CreateFontDialog: Creates the font dialog and stores the names *//*   and sizes of the fonts in the font list in the dialog.       *//******************************************************************/static void CreateFontDialog()  {   /*=============================================*/   /* Indicate a delay while building the dialog. */   /*=============================================*/   SetCursor(*GetCursor(watchCursor));   /*==============================================================*/   /* Create the Set Font dialog box and make it the current port. */   /*==============================================================*/   FontDialog = GetNewDialog(SET_FONT_RESOURCE_NUMBER,0L,(WindowPtr) -1L);   SetPort(FontDialog);   /*=========================*/   /* Display the dialog box. */   /*=========================*/   CenterWindow(FontDialog,0.5,0.33);   ShowWindow(FontDialog);   /*=====================*/   /* Change cursor back. */   /*=====================*/   InitCursor();  }/**********************************************************************//* PerformFontDialog: Handles interaction with user with font dialog. *//**********************************************************************/static int PerformFontDialog(newFontPtr,newSizePtr)  short int *newFontPtr, *newSizePtr;  {   short int itemNum = 0;   short int itemType;   Handle itemHandle;   Rect dispRect;   StringHandle displayString;   short int newFont, newSize;   MenuHandle fontMenu, sizeMenu;   Str255 pStrBuff;   long tempLong;   /*=======================*/   /* Create the font menu. */   /*=======================*/   fontMenu = GetMenu(FONT_MENU_ID);   AddResMenu(fontMenu,'FONT');   InsertMenu(fontMenu,-1);   /*==================================*/   /* Display the font popup menu box. */   /*==================================*/   newFont = FindFontInMenu(*newFontPtr,fontMenu);   DrawPopupMenu(fontMenu,newFont,FontDialog,SET_FONT_DIALOG_USER_ITEM1,TRUE);   /*===========================================================================*/   /* Create the size menu and find the closest match to the current font Size. */   /*===========================================================================*/   sizeMenu = CreateSizeMenu(*newFontPtr,newSizePtr,&newSize);   /*==================================*/   /* Display the size popup menu box. */   /*==================================*/   DrawPopupMenu(sizeMenu,newSize,FontDialog,SET_FONT_DIALOG_USER_ITEM2,TRUE);   /*==================================================================*/   /* Outline the OK button to indicate that it is the default button. */   /*==================================================================*/   OutlineButton(FontDialog,SET_FONT_DIALOG_OK,TRUE);   /*================================================*/   /* Get a handle to the sample string and lock it. */   /*================================================*/   displayString = GetString(DISPLAYSTRINGID);   HLock((Handle) displayString);   /*================*/   /* Draw the text. */   /*================*/   GetDItem(FontDialog,SET_FONT_DIALOG_TEXT,&itemType,&itemHandle,&dispRect);   DrawTextInRect(*newFontPtr,*newSizePtr,(char *) *displayString,&dispRect);   /*============================================================*/   /* Remain in this loop until the user has selected either the */   /* OK or cancel button.                                       */   /*============================================================*/   itemNum = -1;   while ((itemNum != SET_FONT_DIALOG_OK) &&          (itemNum != SET_FONT_DIALOG_CANCEL))     {      ModalDialog((ModalPtr) DefaultDialogFilterRef,&itemNum);      switch (itemNum)        {         case SET_FONT_DIALOG_USER_ITEM1:           /* Handle the popup menu selection. */           newFont = DoPopupMenu(fontMenu,newFont,FontDialog,                                 SET_FONT_DIALOG_POPUP_TEXT1,                                 SET_FONT_DIALOG_USER_ITEM1);           /* Redraw the popup menu after a selection is made. */           DrawPopupMenu(fontMenu,newFont,FontDialog,SET_FONT_DIALOG_USER_ITEM1,TRUE);           /* Determine the new font number. */           GetItem(fontMenu,newFont,pStrBuff);           GetFNum(pStrBuff,newFontPtr);           /* Recreate the size menu. */           DeleteMenu(SIZE_MENU_ID);           DisposeMenu(sizeMenu);           sizeMenu = CreateSizeMenu(*newFontPtr,newSizePtr,&newSize);           /* Redraw the size menu. */           GetDItem(FontDialog,SET_FONT_DIALOG_USER_ITEM2,&itemType,&itemHandle,&dispRect);           InsetRect(&dispRect,-4,-4);           EraseRect(&dispRect);           DrawPopupMenu(sizeMenu,newSize,FontDialog,SET_FONT_DIALOG_USER_ITEM2,TRUE);           /* Redraw the sample text. */           GetDItem(FontDialog,SET_FONT_DIALOG_TEXT,&itemType,&itemHandle,&dispRect);           DrawTextInRect(*newFontPtr,*newSizePtr,(char *) *displayString,&dispRect);           break;         case SET_FONT_DIALOG_USER_ITEM2:           /* Handle the popup menu selection. */           newSize = DoPopupMenu(sizeMenu,newSize,FontDialog,                                 SET_FONT_DIALOG_POPUP_TEXT2,                                 SET_FONT_DIALOG_USER_ITEM2);           /* Redraw the popup menu after a selection is made. */           DrawPopupMenu(sizeMenu,newSize,FontDialog,SET_FONT_DIALOG_USER_ITEM2,TRUE);           /* Determine the new font size. */           GetItem(sizeMenu,newSize,pStrBuff);           StringToNum(pStrBuff,&tempLong);           *newSizePtr = tempLong;           /* Redraw the sample text. */           GetDItem(FontDialog,SET_FONT_DIALOG_TEXT,&itemType,&itemHandle,&dispRect);           DrawTextInRect(*newFontPtr,*newSizePtr,(char *) *displayString,&dispRect);           break;        }     }   /*==============================================================*/   /* Unlock the sample string and mark the resource as purgeable. */   /*==============================================================*/   HUnlock((Handle) displayString);   HPurge((Handle) displayString);   /*==================================*/   /* Destroy the font and size menus. */   /*==================================*/   DeleteMenu(FONT_MENU_ID);   DisposeMenu(fontMenu);   DeleteMenu(SIZE_MENU_ID);   DisposeMenu(sizeMenu);   /*==================================================*/   /* If the cancel button was selected, return false. */   /* Otherwise, return TRUE.                          */   /*==================================================*/   if (itemNum == SET_FONT_DIALOG_CANCEL)     { return(false); }   return(TRUE);  }/***********************************************************//* DrawTextInRect:                                         *//***********************************************************/static void DrawTextInRect(fontNumber,fontSize,theString,theRect)  int fontNumber, fontSize;  char *theString;  Rect *theRect;  {   FontInfo finfo;   TextFont(fontNumber);   TextSize(fontSize);   GetFontInfo(&finfo);   MoveTo(theRect->left,theRect->top + finfo.ascent);   EraseRect(theRect);   DrawText(theString + 1,0,theString[0]);   TextFont(0);   TextSize(0);  }/***********************************************************//* FindFontInMenu:                                      *//***********************************************************/static int FindFontInMenu(fontNumber,theMenu)  int fontNumber;  MenuHandle theMenu;  {   Str255 fontName, menuItem;   int numItems, i;   GetFontName(fontNumber,fontName);   numItems = CountMItems(theMenu);   for (i = 1; i <= numItems; i++)     {      GetItem(theMenu,i,menuItem);      if (IUCompString(fontName,menuItem) == 0) return(i);     }   return(0);  }/***********************************************************//* CreateSizeMenu:                                         *//***********************************************************/static MenuHandle CreateSizeMenu(short theFont,short *theSize,short *closestMatch)  {   MenuHandle sizeMenu;   int i;   Str255 sizeStr;   int lastMatchSize = 0;   int j;   *closestMatch = -1;   sizeMenu = GetMenu(SIZE_MENU_ID);   for (i = 1, j = 0; i <= MAXFONTSIZE ; i++)     {      if (RealFont(theFont,i))        {         j++;         NumToString((long int) i,sizeStr);         AppendMenu(sizeMenu,sizeStr);         if ((*closestMatch == -1) ? TRUE :                                    (abs(i - *theSize) < abs(lastMatchSize - *theSize)))           {            lastMatchSize = i;            *closestMatch = j;           }        }     }   InsertMenu(sizeMenu,-1);   *theSize = lastMatchSize;   return(sizeMenu);  }